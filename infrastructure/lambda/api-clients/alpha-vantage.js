"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AlphaVantageClient = void 0;
class AlphaVantageClient {
    config;
    baseUrl;
    constructor(config) {
        this.config = config;
        this.baseUrl = config.baseUrl || 'https://www.alphavantage.co/query';
    }
    async getIncomeStatement(symbol) {
        const url = new URL(this.baseUrl);
        url.searchParams.set('function', 'INCOME_STATEMENT');
        url.searchParams.set('symbol', symbol);
        url.searchParams.set('apikey', this.config.apiKey);
        const response = await this.makeRequest(url.toString());
        return response;
    }
    async getBalanceSheet(symbol) {
        const url = new URL(this.baseUrl);
        url.searchParams.set('function', 'BALANCE_SHEET');
        url.searchParams.set('symbol', symbol);
        url.searchParams.set('apikey', this.config.apiKey);
        const response = await this.makeRequest(url.toString());
        return response;
    }
    async getCashFlow(symbol) {
        const url = new URL(this.baseUrl);
        url.searchParams.set('function', 'CASH_FLOW');
        url.searchParams.set('symbol', symbol);
        url.searchParams.set('apikey', this.config.apiKey);
        const response = await this.makeRequest(url.toString());
        return response;
    }
    async getCompanyFinancials(symbol) {
        try {
            const [incomeStatement, balanceSheet, cashFlow] = await Promise.all([
                this.getIncomeStatement(symbol),
                this.getBalanceSheet(symbol),
                this.getCashFlow(symbol),
            ]);
            return this.mergeFinancialData(incomeStatement, balanceSheet, cashFlow);
        }
        catch (error) {
            console.error(`Error fetching Alpha Vantage data for ${symbol}:`, error);
            throw new Error(`Failed to fetch financial data from Alpha Vantage: ${error}`);
        }
    }
    async makeRequest(url) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.config.timeout || 10000);
        try {
            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'User-Agent': 'Fintail-Financial-Dashboard/1.0',
                },
            });
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            // Check for API error responses
            if (data && typeof data === 'object' && 'Error Message' in data) {
                throw new Error(`Alpha Vantage API Error: ${data['Error Message']}`);
            }
            if (data && typeof data === 'object' && 'Note' in data) {
                throw new Error(`Alpha Vantage API Limit: ${data['Note']}`);
            }
            return data;
        }
        catch (error) {
            clearTimeout(timeoutId);
            if (error instanceof Error && error.name === 'AbortError') {
                throw new Error('Request timeout');
            }
            throw error;
        }
    }
    mergeFinancialData(incomeStatement, balanceSheet, cashFlow) {
        const financials = [];
        const incomeData = incomeStatement['Quarterly Income Statements'] || {};
        const balanceData = balanceSheet['Quarterly Balance Sheets'] || {};
        const cashFlowData = cashFlow['Quarterly Cash Flow'] || {};
        // Get all unique dates
        const allDates = new Set([
            ...Object.keys(incomeData),
            ...Object.keys(balanceData),
            ...Object.keys(cashFlowData),
        ]);
        for (const date of Array.from(allDates).sort().reverse()) {
            const income = incomeData[date];
            const balance = balanceData[date];
            const cash = cashFlowData[date];
            const financial = {
                quarter: this.dateToQuarter(date),
                reportDate: date,
            };
            // Income statement data
            if (income) {
                financial.totalRevenue = this.parseNumber(income.totalRevenue);
                financial.netSales = this.parseNumber(income.totalRevenue); // Assuming same as revenue
                financial.netIncome = this.parseNumber(income.netIncome);
                financial.operatingIncome = this.parseNumber(income.operatingIncome);
                financial.eps = this.parseNumber(income.eps);
            }
            // Balance sheet data
            if (balance) {
                financial.totalAssets = this.parseNumber(balance.totalAssets);
                financial.totalDebt = this.parseNumber(balance.totalLiabilities);
                financial.shareholderEquity = this.parseNumber(balance.totalShareholderEquity);
            }
            // Cash flow data
            if (cash) {
                financial.freeCashFlow = this.parseNumber(cash.operatingCashflow);
            }
            financials.push(financial);
        }
        return financials.slice(0, 8); // Return last 8 quarters
    }
    parseNumber(value) {
        if (!value || value === 'None' || value === 'null')
            return 0;
        return parseFloat(value.replace(/,/g, '')) || 0;
    }
    dateToQuarter(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const quarter = Math.ceil(month / 3);
        return `${year}-Q${quarter}`;
    }
}
exports.AlphaVantageClient = AlphaVantageClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxwaGEtdmFudGFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFscGhhLXZhbnRhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBNERBLE1BQWEsa0JBQWtCO0lBQ3JCLE1BQU0sQ0FBcUI7SUFDM0IsT0FBTyxDQUFTO0lBRXhCLFlBQVksTUFBMEI7UUFDcEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxJQUFJLG1DQUFtQyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCxLQUFLLENBQUMsa0JBQWtCLENBQUMsTUFBYztRQUNyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEMsR0FBRyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDckQsR0FBRyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZDLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRW5ELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUN4RCxPQUFPLFFBQXlDLENBQUM7SUFDbkQsQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBYztRQUNsQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEMsR0FBRyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ2xELEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMs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QyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQ2pGLENBQUM7WUFFRCxpQkFBaUI7WUFDakIsSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDVCxTQUFTLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDcEUsQ0FBQztZQUVELFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELE9BQU8sVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyx5QkFBeUI7SUFDMUQsQ0FBQztJQUVPLFdBQVcsQ0FBQyxLQUF5QjtRQUMzQyxJQUFJLENBQUMsS0FBSyxJQUFJLEtBQUssS0FBSyxNQUFNLElBQUksS0FBSyxLQUFLLE1BQU07WUFBRSxPQUFPLENBQUMsQ0FBQztRQUM3RCxPQUFPLFVBQVUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRU8sYUFBYSxDQUFDLFVBQWtCO1FBQ3RDLE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLE9BQU8sR0FBRyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7SUFDL0IsQ0FBQztDQUNGO0FBL0pELGdEQStKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1YXJ0ZXJseUZpbmFuY2lhbHMgfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWxwaGFWYW50YWdlQ29uZmlnIHtcbiAgYXBpS2V5OiBzdHJpbmc7XG4gIGJhc2VVcmw/OiBzdHJpbmc7XG4gIHRpbWVvdXQ/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWxwaGFWYW50YWdlUXVhcnRlcmx5UmVzcG9uc2Uge1xuICAnTWV0YSBEYXRhJzoge1xuICAgICcxLiBJbmZvcm1hdGlvbic6IHN0cmluZztcbiAgICAnMi4gU3ltYm9sJzogc3RyaW5nO1xuICAgICczLiBMYXN0IFJlZnJlc2hlZCc6IHN0cmluZztcbiAgICAnNC4gVGltZSBab25lJzogc3RyaW5nO1xuICB9O1xuICAnUXVhcnRlcmx5IEluY29tZSBTdGF0ZW1lbnRzJzoge1xuICAgIFtkYXRlOiBzdHJpbmddOiB7XG4gICAgICB0b3RhbFJldmVudWU6IHN0cmluZztcbiAgICAgIG5ldEluY29tZTogc3RyaW5nO1xuICAgICAgb3BlcmF0aW5nSW5jb21lOiBzdHJpbmc7XG4gICAgICBlcHM6IHN0cmluZztcbiAgICAgIC8vIEFkZCBtb3JlIGZpZWxkcyBhcyBuZWVkZWRcbiAgICB9O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFscGhhVmFudGFnZUJhbGFuY2VTaGVldFJlc3BvbnNlIHtcbiAgJ01ldGEgRGF0YSc6IHtcbiAgICAnMS4gSW5mb3JtYXRpb24nOiBzdHJpbmc7XG4gICAgJzIuIFN5bWJvbCc6IHN0cmluZztcbiAgICAnMy4gTGFzdCBSZWZyZXNoZWQnOiBzdHJpbmc7XG4gICAgJzQuIFRpbWUgWm9uZSc6IHN0cmluZztcbiAgfTtcbiAgJ1F1YXJ0ZXJseSBCYWxhbmNlIFNoZWV0cyc6IHtcbiAgICBbZGF0ZTogc3RyaW5nXToge1xuICAgICAgdG90YWxBc3NldHM6IHN0cmluZztcbiAgICAgIHRvdGFsTGlhYmlsaXRpZXM6IHN0cmluZztcbiAgICAgIHRvdGFsU2hhcmVob2xkZXJFcXVpdHk6IHN0cmluZztcbiAgICAgIC8vIEFkZCBtb3JlIGZpZWxkcyBhcyBuZWVkZWRcbiAgICB9O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFscGhhVmFudGFnZUNhc2hGbG93UmVzcG9uc2Uge1xuICAnTWV0YSBEYXRhJzoge1xuICAgICcxLiBJbmZvcm1hdGlvbic6IHN0cmluZztcbiAgICAnMi4gU3ltYm9sJzogc3RyaW5nO1xuICAgICczLiBMYXN0IFJlZnJlc2hlZCc6IHN0cmluZztcbiAgICAnNC4gVGltZSBab25lJzogc3RyaW5nO1xuICB9O1xuICAnUXVhcnRlcmx5IENhc2ggRmxvdyc6IHtcbiAgICBbZGF0ZTogc3RyaW5nXToge1xuICAgICAgb3BlcmF0aW5nQ2FzaGZsb3c6IHN0cmluZztcbiAgICAgIGNhc2hmbG93RnJvbUludmVzdG1lbnQ6IHN0cmluZztcbiAgICAgIGNhc2hmbG93RnJvbUZpbmFuY2luZzogc3RyaW5nO1xuICAgICAgLy8gQWRkIG1vcmUgZmllbGRzIGFzIG5lZWRlZFxuICAgIH07XG4gIH07XG59XG5cbmV4cG9ydCBjbGFzcyBBbHBoYVZhbnRhZ2VDbGllbnQge1xuICBwcml2YXRlIGNvbmZpZzogQWxwaGFWYW50YWdlQ29uZmlnO1xuICBwcml2YXRlIGJhc2VVcmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IEFscGhhVmFudGFnZUNvbmZpZykge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuYmFzZVVybCA9IGNvbmZpZy5iYXNlVXJsIHx8ICdodHRwczovL3d3dy5hbHBoYXZhbnRhZ2UuY28vcXVlcnknO1xuICB9XG5cbiAgYXN5bmMgZ2V0SW5jb21lU3RhdGVtZW50KHN5bWJvbDogc3RyaW5nKTogUHJvbWlzZTxBbHBoYVZhbnRhZ2VRdWFydGVybHlSZXNwb25zZT4ge1xuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwodGhpcy5iYXNlVXJsKTtcbiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnZnVuY3Rpb24nLCAnSU5DT01FX1NUQVRFTUVOVCcpO1xuICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeW1ib2wnLCBzeW1ib2wpO1xuICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdhcGlrZXknLCB0aGlzLmNvbmZpZy5hcGlLZXkpO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLm1ha2VSZXF1ZXN0KHVybC50b1N0cmluZygpKTtcbiAgICByZXR1cm4gcmVzcG9uc2UgYXMgQWxwaGFWYW50YWdlUXVhcnRlcmx5UmVzcG9uc2U7XG4gIH1cblxuICBhc3luYyBnZXRCYWxhbmNlU2hlZXQoc3ltYm9sOiBzdHJpbmcpOiBQcm9taXNlPEFscGhhVmFudGFnZUJhbGFuY2VTaGVldFJlc3BvbnNlPiB7XG4gICAgY29uc3QgdXJsID0gbmV3IFVSTCh0aGlzLmJhc2VVcmwpO1xuICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdmdW5jdGlvbicsICdCQUxBTkNFX1NIRUVUJyk7XG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3N5bWJvbCcsIHN5bWJvbCk7XG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2FwaWtleScsIHRoaXMuY29uZmlnLmFwaUtleSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubWFrZVJlcXVlc3QodXJsLnRvU3RyaW5nKCkpO1xuICAgIHJldHVybiByZXNwb25zZSBhcyBBbHBoYVZhbnRhZ2VCYWxhbmNlU2hlZXRSZXNwb25zZTtcbiAgfVxuXG4gIGFzeW5jIGdldENhc2hGbG93KHN5bWJvbDogc3RyaW5nKTogUHJvbWlzZTxBbHBoYVZhbnRhZ2VDYXNoRmxvd1Jlc3BvbnNlPiB7XG4gICAgY29uc3QgdXJsID0gbmV3IFVSTCh0aGlzLmJhc2VVcmwpO1xuICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdmdW5jdGlvbicsICdDQVNIX0ZMT1cnKTtcbiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3ltYm9sJywgc3ltYm9sKTtcbiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnYXBpa2V5JywgdGhpcy5jb25maWcuYXBpS2V5KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5tYWtlUmVxdWVzdCh1cmwudG9TdHJpbmcoKSk7XG4gICAgcmV0dXJuIHJlc3BvbnNlIGFzIEFscGhhVmFudGFnZUNhc2hGbG93UmVzcG9uc2U7XG4gIH1cblxuICBhc3luYyBnZXRDb21wYW55RmluYW5jaWFscyhzeW1ib2w6IHN0cmluZyk6IFByb21pc2U8UGFydGlhbDxRdWFydGVybHlGaW5hbmNpYWxzPltdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IFtpbmNvbWVTdGF0ZW1lbnQsIGJhbGFuY2VTaGVldCwgY2FzaEZsb3ddID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICB0aGlzLmdldEluY29tZVN0YXRlbWVudChzeW1ib2wpLFxuICAgICAgICB0aGlzLmdldEJhbGFuY2VTaGVldChzeW1ib2wpLFxuICAgICAgICB0aGlzLmdldENhc2hGbG93KHN5bWJvbCksXG4gICAgICBdKTtcblxuICAgICAgcmV0dXJuIHRoaXMubWVyZ2VGaW5hbmNpYWxEYXRhKGluY29tZVN0YXRlbWVudCwgYmFsYW5jZVNoZWV0LCBjYXNoRmxvdyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGZldGNoaW5nIEFscGhhIFZhbnRhZ2UgZGF0YSBmb3IgJHtzeW1ib2x9OmAsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGZldGNoIGZpbmFuY2lhbCBkYXRhIGZyb20gQWxwaGEgVmFudGFnZTogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG1ha2VSZXF1ZXN0KHVybDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgIGNvbnN0IHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gY29udHJvbGxlci5hYm9ydCgpLCB0aGlzLmNvbmZpZy50aW1lb3V0IHx8IDEwMDAwKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgICAgICBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ1VzZXItQWdlbnQnOiAnRmludGFpbC1GaW5hbmNpYWwtRGFzaGJvYXJkLzEuMCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG5cbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBIVFRQICR7cmVzcG9uc2Uuc3RhdHVzfTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXG4gICAgICAvLyBDaGVjayBmb3IgQVBJIGVycm9yIHJlc3BvbnNlc1xuICAgICAgaWYgKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmICdFcnJvciBNZXNzYWdlJyBpbiBkYXRhKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQWxwaGEgVmFudGFnZSBBUEkgRXJyb3I6ICR7KGRhdGEgYXMgYW55KVsnRXJyb3IgTWVzc2FnZSddfWApO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYgJ05vdGUnIGluIGRhdGEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBbHBoYSBWYW50YWdlIEFQSSBMaW1pdDogJHsoZGF0YSBhcyBhbnkpWydOb3RlJ119YCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGVycm9yLm5hbWUgPT09ICdBYm9ydEVycm9yJykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgdGltZW91dCcpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZUZpbmFuY2lhbERhdGEoXG4gICAgaW5jb21lU3RhdGVtZW50OiBBbHBoYVZhbnRhZ2VRdWFydGVybHlSZXNwb25zZSxcbiAgICBiYWxhbmNlU2hlZXQ6IEFscGhhVmFudGFnZUJhbGFuY2VTaGVldFJlc3BvbnNlLFxuICAgIGNhc2hGbG93OiBBbHBoYVZhbnRhZ2VDYXNoRmxvd1Jlc3BvbnNlXG4gICk6IFBhcnRpYWw8UXVhcnRlcmx5RmluYW5jaWFscz5bXSB7XG4gICAgY29uc3QgZmluYW5jaWFsczogUGFydGlhbDxRdWFydGVybHlGaW5hbmNpYWxzPltdID0gW107XG4gICAgY29uc3QgaW5jb21lRGF0YSA9IGluY29tZVN0YXRlbWVudFsnUXVhcnRlcmx5IEluY29tZSBTdGF0ZW1lbnRzJ10gfHwge307XG4gICAgY29uc3QgYmFsYW5jZURhdGEgPSBiYWxhbmNlU2hlZXRbJ1F1YXJ0ZXJseSBCYWxhbmNlIFNoZWV0cyddIHx8IHt9O1xuICAgIGNvbnN0IGNhc2hGbG93RGF0YSA9IGNhc2hGbG93WydRdWFydGVybHkgQ2FzaCBGbG93J10gfHwge307XG5cbiAgICAvLyBHZXQgYWxsIHVuaXF1ZSBkYXRlc1xuICAgIGNvbnN0IGFsbERhdGVzID0gbmV3IFNldChbXG4gICAgICAuLi5PYmplY3Qua2V5cyhpbmNvbWVEYXRhKSxcbiAgICAgIC4uLk9iamVjdC5rZXlzKGJhbGFuY2VEYXRhKSxcbiAgICAgIC4uLk9iamVjdC5rZXlzKGNhc2hGbG93RGF0YSksXG4gICAgXSk7XG5cbiAgICBmb3IgKGNvbnN0IGRhdGUgb2YgQXJyYXkuZnJvbShhbGxEYXRlcykuc29ydCgpLnJldmVyc2UoKSkge1xuICAgICAgY29uc3QgaW5jb21lID0gaW5jb21lRGF0YVtkYXRlXTtcbiAgICAgIGNvbnN0IGJhbGFuY2UgPSBiYWxhbmNlRGF0YVtkYXRlXTtcbiAgICAgIGNvbnN0IGNhc2ggPSBjYXNoRmxvd0RhdGFbZGF0ZV07XG5cbiAgICAgIGNvbnN0IGZpbmFuY2lhbDogUGFydGlhbDxRdWFydGVybHlGaW5hbmNpYWxzPiA9IHtcbiAgICAgICAgcXVhcnRlcjogdGhpcy5kYXRlVG9RdWFydGVyKGRhdGUpLFxuICAgICAgICByZXBvcnREYXRlOiBkYXRlLFxuICAgICAgfTtcblxuICAgICAgLy8gSW5jb21lIHN0YXRlbWVudCBkYXRhXG4gICAgICBpZiAoaW5jb21lKSB7XG4gICAgICAgIGZpbmFuY2lhbC50b3RhbFJldmVudWUgPSB0aGlzLnBhcnNlTnVtYmVyKGluY29tZS50b3RhbFJldmVudWUpO1xuICAgICAgICBmaW5hbmNpYWwubmV0U2FsZXMgPSB0aGlzLnBhcnNlTnVtYmVyKGluY29tZS50b3RhbFJldmVudWUpOyAvLyBBc3N1bWluZyBzYW1lIGFzIHJldmVudWVcbiAgICAgICAgZmluYW5jaWFsLm5ldEluY29tZSA9IHRoaXMucGFyc2VOdW1iZXIoaW5jb21lLm5ldEluY29tZSk7XG4gICAgICAgIGZpbmFuY2lhbC5vcGVyYXRpbmdJbmNvbWUgPSB0aGlzLnBhcnNlTnVtYmVyKGluY29tZS5vcGVyYXRpbmdJbmNvbWUpO1xuICAgICAgICBmaW5hbmNpYWwuZXBzID0gdGhpcy5wYXJzZU51bWJlcihpbmNvbWUuZXBzKTtcbiAgICAgIH1cblxuICAgICAgLy8gQmFsYW5jZSBzaGVldCBkYXRhXG4gICAgICBpZiAoYmFsYW5jZSkge1xuICAgICAgICBmaW5hbmNpYWwudG90YWxBc3NldHMgPSB0aGlzLnBhcnNlTnVtYmVyKGJhbGFuY2UudG90YWxBc3NldHMpO1xuICAgICAgICBmaW5hbmNpYWwudG90YWxEZWJ0ID0gdGhpcy5wYXJzZU51bWJlcihiYWxhbmNlLnRvdGFsTGlhYmlsaXRpZXMpO1xuICAgICAgICBmaW5hbmNpYWwuc2hhcmVob2xkZXJFcXVpdHkgPSB0aGlzLnBhcnNlTnVtYmVyKGJhbGFuY2UudG90YWxTaGFyZWhvbGRlckVxdWl0eSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENhc2ggZmxvdyBkYXRhXG4gICAgICBpZiAoY2FzaCkge1xuICAgICAgICBmaW5hbmNpYWwuZnJlZUNhc2hGbG93ID0gdGhpcy5wYXJzZU51bWJlcihjYXNoLm9wZXJhdGluZ0Nhc2hmbG93KTtcbiAgICAgIH1cblxuICAgICAgZmluYW5jaWFscy5wdXNoKGZpbmFuY2lhbCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbmFuY2lhbHMuc2xpY2UoMCwgOCk7IC8vIFJldHVybiBsYXN0IDggcXVhcnRlcnNcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VOdW1iZXIodmFsdWU6IHN0cmluZyB8IHVuZGVmaW5lZCk6IG51bWJlciB7XG4gICAgaWYgKCF2YWx1ZSB8fCB2YWx1ZSA9PT0gJ05vbmUnIHx8IHZhbHVlID09PSAnbnVsbCcpIHJldHVybiAwO1xuICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlLnJlcGxhY2UoLywvZywgJycpKSB8fCAwO1xuICB9XG5cbiAgcHJpdmF0ZSBkYXRlVG9RdWFydGVyKGRhdGVTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKGRhdGVTdHJpbmcpO1xuICAgIGNvbnN0IHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgY29uc3QgbW9udGggPSBkYXRlLmdldE1vbnRoKCkgKyAxO1xuICAgIGNvbnN0IHF1YXJ0ZXIgPSBNYXRoLmNlaWwobW9udGggLyAzKTtcbiAgICByZXR1cm4gYCR7eWVhcn0tUSR7cXVhcnRlcn1gO1xuICB9XG59Il19