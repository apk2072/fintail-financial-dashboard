"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FinancialModelingPrepClient = void 0;
class FinancialModelingPrepClient {
    config;
    baseUrl;
    constructor(config) {
        this.config = config;
        this.baseUrl = config.baseUrl || 'https://financialmodelingprep.com/api/v3';
    }
    async getIncomeStatement(symbol, period = 'quarter') {
        const url = `${this.baseUrl}/income-statement/${symbol}?period=${period}&apikey=${this.config.apiKey}`;
        return this.makeRequest(url);
    }
    async getBalanceSheet(symbol, period = 'quarter') {
        const url = `${this.baseUrl}/balance-sheet-statement/${symbol}?period=${period}&apikey=${this.config.apiKey}`;
        return this.makeRequest(url);
    }
    async getCashFlow(symbol, period = 'quarter') {
        const url = `${this.baseUrl}/cash-flow-statement/${symbol}?period=${period}&apikey=${this.config.apiKey}`;
        return this.makeRequest(url);
    }
    async getCompanyFinancials(symbol) {
        try {
            const [incomeStatements, balanceSheets, cashFlows] = await Promise.all([
                this.getIncomeStatement(symbol),
                this.getBalanceSheet(symbol),
                this.getCashFlow(symbol),
            ]);
            return this.mergeFinancialData(incomeStatements, balanceSheets, cashFlows);
        }
        catch (error) {
            console.error(`Error fetching FMP data for ${symbol}:`, error);
            throw new Error(`Failed to fetch financial data from Financial Modeling Prep: ${error}`);
        }
    }
    async makeRequest(url) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.config.timeout || 10000);
        try {
            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'User-Agent': 'Fintail-Financial-Dashboard/1.0',
                },
            });
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            // Check for API error responses
            if (data && typeof data === 'object' && 'error' in data) {
                throw new Error(`FMP API Error: ${data.error}`);
            }
            if (Array.isArray(data) && data.length === 0) {
                throw new Error('No data available for this symbol');
            }
            return data;
        }
        catch (error) {
            clearTimeout(timeoutId);
            if (error instanceof Error && error.name === 'AbortError') {
                throw new Error('Request timeout');
            }
            throw error;
        }
    }
    mergeFinancialData(incomeStatements, balanceSheets, cashFlows) {
        const financials = [];
        // Create a map for quick lookups
        const balanceMap = new Map(balanceSheets.map(item => [item.date, item]));
        const cashFlowMap = new Map(cashFlows.map(item => [item.date, item]));
        for (const income of incomeStatements.slice(0, 8)) { // Last 8 quarters
            const balance = balanceMap.get(income.date);
            const cashFlow = cashFlowMap.get(income.date);
            const financial = {
                quarter: this.dateToQuarter(income.date),
                reportDate: income.date,
                totalRevenue: income.revenue || 0,
                netSales: income.revenue || 0,
                netIncome: income.netIncome || 0,
                operatingIncome: income.operatingIncome || 0,
                eps: income.eps || 0,
                sharesOutstanding: income.weightedAverageShsOut || 0,
            };
            if (balance) {
                financial.totalAssets = balance.totalAssets || 0;
                financial.totalDebt = balance.totalDebt || 0;
                financial.shareholderEquity = balance.totalStockholdersEquity || 0;
            }
            if (cashFlow) {
                financial.freeCashFlow = cashFlow.freeCashFlow || 0;
            }
            financials.push(financial);
        }
        return financials;
    }
    dateToQuarter(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const quarter = Math.ceil(month / 3);
        return `${year}-Q${quarter}`;
    }
}
exports.FinancialModelingPrepClient = FinancialModelingPrepClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmluYW5jaWFsLW1vZGVsaW5nLXByZXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmaW5hbmNpYWwtbW9kZWxpbmctcHJlcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUErSUEsTUFBYSwyQkFBMkI7SUFDOUIsTUFBTSxDQUE4QjtJQUNwQyxPQUFPLENBQVM7SUFFeEIsWUFBWSxNQUFtQztRQUM3QyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLElBQUksMENBQTBDLENBQUM7SUFDOUUsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxNQUFjLEVBQUUsU0FBK0IsU0FBUztRQUMvRSxNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLHFCQUFxQixNQUFNLFdBQVcsTUFBTSxXQUFXLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDdkcsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQWMsRUFBRSxTQUErQixTQUFTO1FBQzVFLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sNEJBQTRCLE1BQU0sV0FBVyxNQUFNLFdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUM5RyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXLENBQUMsTUFBYyxFQUFFLFNBQStCLFNBQVM7UUFDeEUsTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyx3QkFBd0IsTUFBTSxXQUFXLE1BQU0sV0FBVyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzFHLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxH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Z0JBQzdDLFNBQVMsQ0FBQyxpQkFBaUIsR0FBRyxPQUFPLENBQUMsdUJBQXVCLElBQUksQ0FBQyxDQUFDO1lBQ3JFLENBQUM7WUFFRCxJQUFJLFFBQVEsRUFBRSxDQUFDO2dCQUNiLFNBQVMsQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDLFlBQVksSUFBSSxDQUFDLENBQUM7WUFDdEQsQ0FBQztZQUVELFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFTyxhQUFhLENBQUMsVUFBa0I7UUFDdEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2hDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDckMsT0FBTyxHQUFHLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztJQUMvQixDQUFDO0NBQ0Y7QUEvSEQsa0VBK0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUXVhcnRlcmx5RmluYW5jaWFscyB9IGZyb20gJy4uL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBGaW5hbmNpYWxNb2RlbGluZ1ByZXBDb25maWcge1xuICBhcGlLZXk6IHN0cmluZztcbiAgYmFzZVVybD86IHN0cmluZztcbiAgdGltZW91dD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGTVBJbmNvbWVTdGF0ZW1lbnRSZXNwb25zZSB7XG4gIGRhdGU6IHN0cmluZztcbiAgc3ltYm9sOiBzdHJpbmc7XG4gIHJlcG9ydGVkQ3VycmVuY3k6IHN0cmluZztcbiAgY2lrOiBzdHJpbmc7XG4gIGZpbGxpbmdEYXRlOiBzdHJpbmc7XG4gIGFjY2VwdGVkRGF0ZTogc3RyaW5nO1xuICBjYWxlbmRhclllYXI6IHN0cmluZztcbiAgcGVyaW9kOiBzdHJpbmc7XG4gIHJldmVudWU6IG51bWJlcjtcbiAgY29zdE9mUmV2ZW51ZTogbnVtYmVyO1xuICBncm9zc1Byb2ZpdDogbnVtYmVyO1xuICBncm9zc1Byb2ZpdFJhdGlvOiBudW1iZXI7XG4gIHJlc2VhcmNoQW5kRGV2ZWxvcG1lbnRFeHBlbnNlczogbnVtYmVyO1xuICBnZW5lcmFsQW5kQWRtaW5pc3RyYXRpdmVFeHBlbnNlczogbnVtYmVyO1xuICBzZWxsaW5nQW5kTWFya2V0aW5nRXhwZW5zZXM6IG51bWJlcjtcbiAgc2VsbGluZ0dlbmVyYWxBbmRBZG1pbmlzdHJhdGl2ZUV4cGVuc2VzOiBudW1iZXI7XG4gIG90aGVyRXhwZW5zZXM6IG51bWJlcjtcbiAgb3BlcmF0aW5nRXhwZW5zZXM6IG51bWJlcjtcbiAgY29zdEFuZEV4cGVuc2VzOiBudW1iZXI7XG4gIGludGVyZXN0SW5jb21lOiBudW1iZXI7XG4gIGludGVyZXN0RXhwZW5zZTogbnVtYmVyO1xuICBkZXByZWNpYXRpb25BbmRBbW9ydGl6YXRpb246IG51bWJlcjtcbiAgZWJpdGRhOiBudW1iZXI7XG4gIGViaXRkYXJhdGlvOiBudW1iZXI7XG4gIG9wZXJhdGluZ0luY29tZTogbnVtYmVyO1xuICBvcGVyYXRpbmdJbmNvbWVSYXRpbzogbnVtYmVyO1xuICB0b3RhbE90aGVySW5jb21lRXhwZW5zZXNOZXQ6IG51bWJlcjtcbiAgaW5jb21lQmVmb3JlVGF4OiBudW1iZXI7XG4gIGluY29tZUJlZm9yZVRheFJhdGlvOiBudW1iZXI7XG4gIGluY29tZVRheEV4cGVuc2U6IG51bWJlcjtcbiAgbmV0SW5jb21lOiBudW1iZXI7XG4gIG5ldEluY29tZVJhdGlvOiBudW1iZXI7XG4gIGVwczogbnVtYmVyO1xuICBlcHNkaWx1dGVkOiBudW1iZXI7XG4gIHdlaWdodGVkQXZlcmFnZVNoc091dDogbnVtYmVyO1xuICB3ZWlnaHRlZEF2ZXJhZ2VTaHNPdXREaWw6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGTVBCYWxhbmNlU2hlZXRSZXNwb25zZSB7XG4gIGRhdGU6IHN0cmluZztcbiAgc3ltYm9sOiBzdHJpbmc7XG4gIHJlcG9ydGVkQ3VycmVuY3k6IHN0cmluZztcbiAgY2lrOiBzdHJpbmc7XG4gIGZpbGxpbmdEYXRlOiBzdHJpbmc7XG4gIGFjY2VwdGVkRGF0ZTogc3RyaW5nO1xuICBjYWxlbmRhclllYXI6IHN0cmluZztcbiAgcGVyaW9kOiBzdHJpbmc7XG4gIGNhc2hBbmRDYXNoRXF1aXZhbGVudHM6IG51bWJlcjtcbiAgc2hvcnRUZXJtSW52ZXN0bWVudHM6IG51bWJlcjtcbiAgY2FzaEFuZFNob3J0VGVybUludmVzdG1lbnRzOiBudW1iZXI7XG4gIG5ldFJlY2VpdmFibGVzOiBudW1iZXI7XG4gIGludmVudG9yeTogbnVtYmVyO1xuICBvdGhlckN1cnJlbnRBc3NldHM6IG51bWJlcjtcbiAgdG90YWxDdXJyZW50QXNzZXRzOiBudW1iZXI7XG4gIHByb3BlcnR5UGxhbnRFcXVpcG1lbnROZXQ6IG51bWJlcjtcbiAgZ29vZHdpbGw6IG51bWJlcjtcbiAgaW50YW5naWJsZUFzc2V0czogbnVtYmVyO1xuICBnb29kd2lsbEFuZEludGFuZ2libGVBc3NldHM6IG51bWJlcjtcbiAgbG9uZ1Rlcm1JbnZlc3RtZW50czogbnVtYmVyO1xuICB0YXhBc3NldHM6IG51bWJlcjtcbiAgb3RoZXJOb25DdXJyZW50QXNzZXRzOiBudW1iZXI7XG4gIHRvdGFsTm9uQ3VycmVudEFzc2V0czogbnVtYmVyO1xuICBvdGhlckFzc2V0czogbnVtYmVyO1xuICB0b3RhbEFzc2V0czogbnVtYmVyO1xuICBhY2NvdW50UGF5YWJsZXM6IG51bWJlcjtcbiAgc2hvcnRUZXJtRGVidDogbnVtYmVyO1xuICB0YXhQYXlhYmxlczogbnVtYmVyO1xuICBkZWZlcnJlZFJldmVudWU6IG51bWJlcjtcbiAgb3RoZXJDdXJyZW50TGlhYmlsaXRpZXM6IG51bWJlcjtcbiAgdG90YWxDdXJyZW50TGlhYmlsaXRpZXM6IG51bWJlcjtcbiAgbG9uZ1Rlcm1EZWJ0OiBudW1iZXI7XG4gIGRlZmVycmVkUmV2ZW51ZU5vbkN1cnJlbnQ6IG51bWJlcjtcbiAgZGVmZXJyZWRUYXhMaWFiaWxpdGllc05vbkN1cnJlbnQ6IG51bWJlcjtcbiAgb3RoZXJOb25DdXJyZW50TGlhYmlsaXRpZXM6IG51bWJlcjtcbiAgdG90YWxOb25DdXJyZW50TGlhYmlsaXRpZXM6IG51bWJlcjtcbiAgb3RoZXJMaWFiaWxpdGllczogbnVtYmVyO1xuICBjYXBpdGFsTGVhc2VPYmxpZ2F0aW9uczogbnVtYmVyO1xuICB0b3RhbExpYWJpbGl0aWVzOiBudW1iZXI7XG4gIHByZWZlcnJlZFN0b2NrOiBudW1iZXI7XG4gIGNvbW1vblN0b2NrOiBudW1iZXI7XG4gIHJldGFpbmVkRWFybmluZ3M6IG51bWJlcjtcbiAgYWNjdW11bGF0ZWRPdGhlckNvbXByZWhlbnNpdmVJbmNvbWVMb3NzOiBudW1iZXI7XG4gIG90aGVydG90YWxTdG9ja2hvbGRlcnNFcXVpdHk6IG51bWJlcjtcbiAgdG90YWxTdG9ja2hvbGRlcnNFcXVpdHk6IG51bWJlcjtcbiAgdG90YWxFcXVpdHk6IG51bWJlcjtcbiAgdG90YWxMaWFiaWxpdGllc0FuZFN0b2NraG9sZGVyc0VxdWl0eTogbnVtYmVyO1xuICBtaW5vcml0eUludGVyZXN0OiBudW1iZXI7XG4gIHRvdGFsTGlhYmlsaXRpZXNBbmRUb3RhbEVxdWl0eTogbnVtYmVyO1xuICB0b3RhbEludmVzdG1lbnRzOiBudW1iZXI7XG4gIHRvdGFsRGVidDogbnVtYmVyO1xuICBuZXREZWJ0OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRk1QQ2FzaEZsb3dSZXNwb25zZSB7XG4gIGRhdGU6IHN0cmluZztcbiAgc3ltYm9sOiBzdHJpbmc7XG4gIHJlcG9ydGVkQ3VycmVuY3k6IHN0cmluZztcbiAgY2lrOiBzdHJpbmc7XG4gIGZpbGxpbmdEYXRlOiBzdHJpbmc7XG4gIGFjY2VwdGVkRGF0ZTogc3RyaW5nO1xuICBjYWxlbmRhclllYXI6IHN0cmluZztcbiAgcGVyaW9kOiBzdHJpbmc7XG4gIG5ldEluY29tZTogbnVtYmVyO1xuICBkZXByZWNpYXRpb25BbmRBbW9ydGl6YXRpb246IG51bWJlcjtcbiAgZGVmZXJyZWRJbmNvbWVUYXg6IG51bWJlcjtcbiAgc3RvY2tCYXNlZENvbXBlbnNhdGlvbjogbnVtYmVyO1xuICBjaGFuZ2VJbldvcmtpbmdDYXBpdGFsOiBudW1iZXI7XG4gIGFjY291bnRzUmVjZWl2YWJsZXM6IG51bWJlcjtcbiAgaW52ZW50b3J5OiBudW1iZXI7XG4gIGFjY291bnRzUGF5YWJsZXM6IG51bWJlcjtcbiAgb3RoZXJXb3JraW5nQ2FwaXRhbDogbnVtYmVyO1xuICBvdGhlck5vbkNhc2hJdGVtczogbnVtYmVyO1xuICBuZXRDYXNoUHJvdmlkZWRCeU9wZXJhdGluZ0FjdGl2aXRpZXM6IG51bWJlcjtcbiAgaW52ZXN0bWVudHNJblByb3BlcnR5UGxhbnRBbmRFcXVpcG1lbnQ6IG51bWJlcjtcbiAgYWNxdWlzaXRpb25zTmV0OiBudW1iZXI7XG4gIHB1cmNoYXNlc09mSW52ZXN0bWVudHM6IG51bWJlcjtcbiAgc2FsZXNNYXR1cml0aWVzT2ZJbnZlc3RtZW50czogbnVtYmVyO1xuICBvdGhlckludmVzdGluZ0FjdGl2aXRlczogbnVtYmVyO1xuICBuZXRDYXNoVXNlZEZvckludmVzdGluZ0FjdGl2aXRlczogbnVtYmVyO1xuICBkZWJ0UmVwYXltZW50OiBudW1iZXI7XG4gIGNvbW1vblN0b2NrSXNzdWVkOiBudW1iZXI7XG4gIGNvbW1vblN0b2NrUmVwdXJjaGFzZWQ6IG51bWJlcjtcbiAgZGl2aWRlbmRzUGFpZDogbnVtYmVyO1xuICBvdGhlckZpbmFuY2luZ0FjdGl2aXRlczogbnVtYmVyO1xuICBuZXRDYXNoVXNlZFByb3ZpZGVkQnlGaW5hbmNpbmdBY3Rpdml0aWVzOiBudW1iZXI7XG4gIGVmZmVjdE9mRm9yZXhDaGFuZ2VzT25DYXNoOiBudW1iZXI7XG4gIG5ldENoYW5nZUluQ2FzaDogbnVtYmVyO1xuICBjYXNoQXRFbmRPZlBlcmlvZDogbnVtYmVyO1xuICBjYXNoQXRCZWdpbm5pbmdPZlBlcmlvZDogbnVtYmVyO1xuICBvcGVyYXRpbmdDYXNoRmxvdzogbnVtYmVyO1xuICBjYXBpdGFsRXhwZW5kaXR1cmU6IG51bWJlcjtcbiAgZnJlZUNhc2hGbG93OiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBGaW5hbmNpYWxNb2RlbGluZ1ByZXBDbGllbnQge1xuICBwcml2YXRlIGNvbmZpZzogRmluYW5jaWFsTW9kZWxpbmdQcmVwQ29uZmlnO1xuICBwcml2YXRlIGJhc2VVcmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IEZpbmFuY2lhbE1vZGVsaW5nUHJlcENvbmZpZykge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuYmFzZVVybCA9IGNvbmZpZy5iYXNlVXJsIHx8ICdodHRwczovL2ZpbmFuY2lhbG1vZGVsaW5ncHJlcC5jb20vYXBpL3YzJztcbiAgfVxuXG4gIGFzeW5jIGdldEluY29tZVN0YXRlbWVudChzeW1ib2w6IHN0cmluZywgcGVyaW9kOiAncXVhcnRlcicgfCAnYW5udWFsJyA9ICdxdWFydGVyJyk6IFByb21pc2U8Rk1QSW5jb21lU3RhdGVtZW50UmVzcG9uc2VbXT4ge1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmFzZVVybH0vaW5jb21lLXN0YXRlbWVudC8ke3N5bWJvbH0/cGVyaW9kPSR7cGVyaW9kfSZhcGlrZXk9JHt0aGlzLmNvbmZpZy5hcGlLZXl9YDtcbiAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdCh1cmwpO1xuICB9XG5cbiAgYXN5bmMgZ2V0QmFsYW5jZVNoZWV0KHN5bWJvbDogc3RyaW5nLCBwZXJpb2Q6ICdxdWFydGVyJyB8ICdhbm51YWwnID0gJ3F1YXJ0ZXInKTogUHJvbWlzZTxGTVBCYWxhbmNlU2hlZXRSZXNwb25zZVtdPiB7XG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy5iYXNlVXJsfS9iYWxhbmNlLXNoZWV0LXN0YXRlbWVudC8ke3N5bWJvbH0/cGVyaW9kPSR7cGVyaW9kfSZhcGlrZXk9JHt0aGlzLmNvbmZpZy5hcGlLZXl9YDtcbiAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdCh1cmwpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q2FzaEZsb3coc3ltYm9sOiBzdHJpbmcsIHBlcmlvZDogJ3F1YXJ0ZXInIHwgJ2FubnVhbCcgPSAncXVhcnRlcicpOiBQcm9taXNlPEZNUENhc2hGbG93UmVzcG9uc2VbXT4ge1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmFzZVVybH0vY2FzaC1mbG93LXN0YXRlbWVudC8ke3N5bWJvbH0/cGVyaW9kPSR7cGVyaW9kfSZhcGlrZXk9JHt0aGlzLmNvbmZpZy5hcGlLZXl9YDtcbiAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdCh1cmwpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29tcGFueUZpbmFuY2lhbHMoc3ltYm9sOiBzdHJpbmcpOiBQcm9taXNlPFBhcnRpYWw8UXVhcnRlcmx5RmluYW5jaWFscz5bXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBbaW5jb21lU3RhdGVtZW50cywgYmFsYW5jZVNoZWV0cywgY2FzaEZsb3dzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgdGhpcy5nZXRJbmNvbWVTdGF0ZW1lbnQoc3ltYm9sKSxcbiAgICAgICAgdGhpcy5nZXRCYWxhbmNlU2hlZXQoc3ltYm9sKSxcbiAgICAgICAgdGhpcy5nZXRDYXNoRmxvdyhzeW1ib2wpLFxuICAgICAgXSk7XG5cbiAgICAgIHJldHVybiB0aGlzLm1lcmdlRmluYW5jaWFsRGF0YShpbmNvbWVTdGF0ZW1lbnRzLCBiYWxhbmNlU2hlZXRzLCBjYXNoRmxvd3MpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBmZXRjaGluZyBGTVAgZGF0YSBmb3IgJHtzeW1ib2x9OmAsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGZldGNoIGZpbmFuY2lhbCBkYXRhIGZyb20gRmluYW5jaWFsIE1vZGVsaW5nIFByZXA6ICR7ZXJyb3J9YCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBtYWtlUmVxdWVzdCh1cmw6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTtcbiAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgdGhpcy5jb25maWcudGltZW91dCB8fCAxMDAwMCk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdVc2VyLUFnZW50JzogJ0ZpbnRhaWwtRmluYW5jaWFsLURhc2hib2FyZC8xLjAnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcblxuICAgICAgLy8gQ2hlY2sgZm9yIEFQSSBlcnJvciByZXNwb25zZXNcbiAgICAgIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiAnZXJyb3InIGluIGRhdGEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGTVAgQVBJIEVycm9yOiAkeyhkYXRhIGFzIGFueSkuZXJyb3J9YCk7XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpICYmIGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZGF0YSBhdmFpbGFibGUgZm9yIHRoaXMgc3ltYm9sJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGVycm9yLm5hbWUgPT09ICdBYm9ydEVycm9yJykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgdGltZW91dCcpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZUZpbmFuY2lhbERhdGEoXG4gICAgaW5jb21lU3RhdGVtZW50czogRk1QSW5jb21lU3RhdGVtZW50UmVzcG9uc2VbXSxcbiAgICBiYWxhbmNlU2hlZXRzOiBGTVBCYWxhbmNlU2hlZXRSZXNwb25zZVtdLFxuICAgIGNhc2hGbG93czogRk1QQ2FzaEZsb3dSZXNwb25zZVtdXG4gICk6IFBhcnRpYWw8UXVhcnRlcmx5RmluYW5jaWFscz5bXSB7XG4gICAgY29uc3QgZmluYW5jaWFsczogUGFydGlhbDxRdWFydGVybHlGaW5hbmNpYWxzPltdID0gW107XG5cbiAgICAvLyBDcmVhdGUgYSBtYXAgZm9yIHF1aWNrIGxvb2t1cHNcbiAgICBjb25zdCBiYWxhbmNlTWFwID0gbmV3IE1hcChiYWxhbmNlU2hlZXRzLm1hcChpdGVtID0+IFtpdGVtLmRhdGUsIGl0ZW1dKSk7XG4gICAgY29uc3QgY2FzaEZsb3dNYXAgPSBuZXcgTWFwKGNhc2hGbG93cy5tYXAoaXRlbSA9PiBbaXRlbS5kYXRlLCBpdGVtXSkpO1xuXG4gICAgZm9yIChjb25zdCBpbmNvbWUgb2YgaW5jb21lU3RhdGVtZW50cy5zbGljZSgwLCA4KSkgeyAvLyBMYXN0IDggcXVhcnRlcnNcbiAgICAgIGNvbnN0IGJhbGFuY2UgPSBiYWxhbmNlTWFwLmdldChpbmNvbWUuZGF0ZSk7XG4gICAgICBjb25zdCBjYXNoRmxvdyA9IGNhc2hGbG93TWFwLmdldChpbmNvbWUuZGF0ZSk7XG5cbiAgICAgIGNvbnN0IGZpbmFuY2lhbDogUGFydGlhbDxRdWFydGVybHlGaW5hbmNpYWxzPiA9IHtcbiAgICAgICAgcXVhcnRlcjogdGhpcy5kYXRlVG9RdWFydGVyKGluY29tZS5kYXRlKSxcbiAgICAgICAgcmVwb3J0RGF0ZTogaW5jb21lLmRhdGUsXG4gICAgICAgIHRvdGFsUmV2ZW51ZTogaW5jb21lLnJldmVudWUgfHwgMCxcbiAgICAgICAgbmV0U2FsZXM6IGluY29tZS5yZXZlbnVlIHx8IDAsXG4gICAgICAgIG5ldEluY29tZTogaW5jb21lLm5ldEluY29tZSB8fCAwLFxuICAgICAgICBvcGVyYXRpbmdJbmNvbWU6IGluY29tZS5vcGVyYXRpbmdJbmNvbWUgfHwgMCxcbiAgICAgICAgZXBzOiBpbmNvbWUuZXBzIHx8IDAsXG4gICAgICAgIHNoYXJlc091dHN0YW5kaW5nOiBpbmNvbWUud2VpZ2h0ZWRBdmVyYWdlU2hzT3V0IHx8IDAsXG4gICAgICB9O1xuXG4gICAgICBpZiAoYmFsYW5jZSkge1xuICAgICAgICBmaW5hbmNpYWwudG90YWxBc3NldHMgPSBiYWxhbmNlLnRvdGFsQXNzZXRzIHx8IDA7XG4gICAgICAgIGZpbmFuY2lhbC50b3RhbERlYnQgPSBiYWxhbmNlLnRvdGFsRGVidCB8fCAwO1xuICAgICAgICBmaW5hbmNpYWwuc2hhcmVob2xkZXJFcXVpdHkgPSBiYWxhbmNlLnRvdGFsU3RvY2tob2xkZXJzRXF1aXR5IHx8IDA7XG4gICAgICB9XG5cbiAgICAgIGlmIChjYXNoRmxvdykge1xuICAgICAgICBmaW5hbmNpYWwuZnJlZUNhc2hGbG93ID0gY2FzaEZsb3cuZnJlZUNhc2hGbG93IHx8IDA7XG4gICAgICB9XG5cbiAgICAgIGZpbmFuY2lhbHMucHVzaChmaW5hbmNpYWwpO1xuICAgIH1cblxuICAgIHJldHVybiBmaW5hbmNpYWxzO1xuICB9XG5cbiAgcHJpdmF0ZSBkYXRlVG9RdWFydGVyKGRhdGVTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKGRhdGVTdHJpbmcpO1xuICAgIGNvbnN0IHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgY29uc3QgbW9udGggPSBkYXRlLmdldE1vbnRoKCkgKyAxO1xuICAgIGNvbnN0IHF1YXJ0ZXIgPSBNYXRoLmNlaWwobW9udGggLyAzKTtcbiAgICByZXR1cm4gYCR7eWVhcn0tUSR7cXVhcnRlcn1gO1xuICB9XG59Il19