"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.YahooFinanceClient = void 0;
class YahooFinanceClient {
    config;
    baseUrl;
    constructor(config = {}) {
        this.config = config;
        this.baseUrl = config.baseUrl || 'https://query1.finance.yahoo.com/v10/finance';
    }
    async getQuoteSummary(symbol) {
        const modules = [
            'financialData',
            'defaultKeyStatistics',
            'summaryDetail',
            'balanceSheetHistory',
            'incomeStatementHistory',
            'cashflowStatementHistory',
        ].join(',');
        const url = `${this.baseUrl}/quoteSummary/${symbol}?modules=${modules}`;
        return this.makeRequest(url);
    }
    async getCompanyFinancials(symbol) {
        try {
            const quoteSummary = await this.getQuoteSummary(symbol);
            if (quoteSummary.quoteSummary.error) {
                throw new Error(`Yahoo Finance API Error: ${quoteSummary.quoteSummary.error.description}`);
            }
            return this.extractFinancialData(quoteSummary);
        }
        catch (error) {
            console.error(`Error fetching Yahoo Finance data for ${symbol}:`, error);
            throw new Error(`Failed to fetch financial data from Yahoo Finance: ${error}`);
        }
    }
    async makeRequest(url) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.config.timeout || 10000);
        try {
            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                    'Accept': 'application/json',
                },
            });
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            return data;
        }
        catch (error) {
            clearTimeout(timeoutId);
            if (error instanceof Error && error.name === 'AbortError') {
                throw new Error('Request timeout');
            }
            throw error;
        }
    }
    extractFinancialData(quoteSummary) {
        const result = quoteSummary.quoteSummary.result[0];
        if (!result) {
            return [];
        }
        const financials = [];
        // Get current quarter data from financialData
        if (result.financialData) {
            const currentQuarter = {
                quarter: this.getCurrentQuarter(),
                reportDate: new Date().toISOString().split('T')[0],
                totalRevenue: this.extractValue(result.financialData.totalRevenue),
                netSales: this.extractValue(result.financialData.totalRevenue),
                netIncome: this.extractValue(result.financialData.netIncomeToCommon),
                freeCashFlow: this.extractValue(result.financialData.freeCashflow),
            };
            if (result.defaultKeyStatistics) {
                currentQuarter.eps = this.extractValue(result.defaultKeyStatistics.trailingEps);
                currentQuarter.sharesOutstanding = this.extractValue(result.defaultKeyStatistics.sharesOutstanding);
            }
            financials.push(currentQuarter);
        }
        // Extract historical data from income statements
        if (result.incomeStatementHistory?.incomeStatementHistory) {
            for (const statement of result.incomeStatementHistory.incomeStatementHistory.slice(0, 4)) {
                const date = new Date(statement.endDate.raw * 1000);
                const quarter = {
                    quarter: this.dateToQuarter(date),
                    reportDate: date.toISOString().split('T')[0],
                    totalRevenue: this.extractValue(statement.totalRevenue),
                    netSales: this.extractValue(statement.totalRevenue),
                    netIncome: this.extractValue(statement.netIncome),
                    operatingIncome: this.extractValue(statement.operatingIncome),
                };
                financials.push(quarter);
            }
        }
        // Merge with balance sheet data
        if (result.balanceSheetHistory?.balanceSheetStatements) {
            const balanceMap = new Map(result.balanceSheetHistory.balanceSheetStatements.map(statement => [
                statement.endDate.raw,
                statement,
            ]));
            financials.forEach(financial => {
                if (financial.reportDate) {
                    const timestamp = Math.floor(new Date(financial.reportDate).getTime() / 1000);
                    const balanceSheet = balanceMap.get(timestamp);
                    if (balanceSheet) {
                        financial.totalAssets = this.extractValue(balanceSheet.totalAssets);
                        financial.totalDebt = this.extractValue(balanceSheet.shortLongTermDebt);
                        financial.shareholderEquity = this.extractValue(balanceSheet.totalStockholderEquity);
                    }
                }
            });
        }
        // Merge with cash flow data
        if (result.cashflowStatementHistory?.cashflowStatements) {
            const cashFlowMap = new Map(result.cashflowStatementHistory.cashflowStatements.map(statement => [
                statement.endDate.raw,
                statement,
            ]));
            financials.forEach(financial => {
                if (financial.reportDate) {
                    const timestamp = Math.floor(new Date(financial.reportDate).getTime() / 1000);
                    const cashFlow = cashFlowMap.get(timestamp);
                    if (cashFlow) {
                        financial.freeCashFlow = this.extractValue(cashFlow.freeCashflow);
                    }
                }
            });
        }
        return financials.filter(f => f.totalRevenue && f.totalRevenue > 0).slice(0, 8);
    }
    extractValue(field) {
        return field?.raw || 0;
    }
    getCurrentQuarter() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const quarter = Math.ceil(month / 3);
        return `${year}-Q${quarter}`;
    }
    dateToQuarter(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const quarter = Math.ceil(month / 3);
        return `${year}-Q${quarter}`;
    }
}
exports.YahooFinanceClient = YahooFinanceClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWFob28tZmluYW5jZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInlhaG9vLWZpbmFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBdUVBLE1BQWEsa0JBQWtCO0lBQ3JCLE1BQU0sQ0FBcUI7SUFDM0IsT0FBTyxDQUFTO0lBRXhCLFlBQVksU0FBNkIsRUFBRTtRQUN6QyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLElBQUksOENBQThDLENBQUM7SUFDbEYsQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBYztRQUNsQyxNQUFNLE9BQU8sR0FBRztZQUNkLGVBQWU7WUFDZixzQkFBc0I7WUFDdEIsZUFBZTtZQUNmLHFCQUFxQjtZQUNyQix3QkFBd0I7WUFDeEIsMEJBQTBCO1NBQzNCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRVosTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxpQkFBaUIsTUFBTSxZQUFZLE9BQU8sRUFBRSxDQUFDO1FBQ3hFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsS0FBSyxDQUFDLG9CQUFvQixDQUFDLE1BQWM7UUFDdkMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXhELElBQUksWUFBWSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDcEMsTUFBTSxJQUFJLEtBQUssQ0FBQyw0QkFBNEIsWUFBWSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUM3RixDQUFDO1lBRUQsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakQsQ0FBQztRQUFDLE9BQU8sS0FBSyxF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QWEsQ0FBQyxJQUFVO1FBQzlCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLE9BQU8sR0FBRyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7SUFDL0IsQ0FBQztDQUNGO0FBakxELGdEQWlMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1YXJ0ZXJseUZpbmFuY2lhbHMgfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgWWFob29GaW5hbmNlQ29uZmlnIHtcbiAgYmFzZVVybD86IHN0cmluZztcbiAgdGltZW91dD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBZYWhvb1F1b3RlU3VtbWFyeVJlc3BvbnNlIHtcbiAgcXVvdGVTdW1tYXJ5OiB7XG4gICAgcmVzdWx0OiBBcnJheTx7XG4gICAgICBmaW5hbmNpYWxEYXRhPzoge1xuICAgICAgICB0b3RhbFJldmVudWU/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICBuZXRJbmNvbWVUb0NvbW1vbj86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgIG9wZXJhdGluZ0Nhc2hmbG93PzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgZnJlZUNhc2hmbG93PzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgdG90YWxDYXNoPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgdG90YWxEZWJ0PzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgZWJpdGRhPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgZ3Jvc3NNYXJnaW5zPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgb3BlcmF0aW5nTWFyZ2lucz86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgIHByb2ZpdE1hcmdpbnM/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgfTtcbiAgICAgIGRlZmF1bHRLZXlTdGF0aXN0aWNzPzoge1xuICAgICAgICBzaGFyZXNPdXRzdGFuZGluZz86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgIGVudGVycHJpc2VWYWx1ZT86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgIHRyYWlsaW5nRXBzPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgZm9yd2FyZEVwcz86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgIHBlZ1JhdGlvPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgcHJpY2VUb0Jvb2s/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgfTtcbiAgICAgIHN1bW1hcnlEZXRhaWw/OiB7XG4gICAgICAgIG1hcmtldENhcD86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgIHRyYWlsaW5nUEU/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICBmb3J3YXJkUEU/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICBkaXZpZGVuZFlpZWxkPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgIH07XG4gICAgICBiYWxhbmNlU2hlZXRIaXN0b3J5Pzoge1xuICAgICAgICBiYWxhbmNlU2hlZXRTdGF0ZW1lbnRzOiBBcnJheTx7XG4gICAgICAgICAgZW5kRGF0ZTogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgICB0b3RhbEFzc2V0cz86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgICAgdG90YWxMaWFiPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgICB0b3RhbFN0b2NraG9sZGVyRXF1aXR5PzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgICBjYXNoPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgICBzaG9ydExvbmdUZXJtRGVidD86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgIH0+O1xuICAgICAgfTtcbiAgICAgIGluY29tZVN0YXRlbWVudEhpc3Rvcnk/OiB7XG4gICAgICAgIGluY29tZVN0YXRlbWVudEhpc3Rvcnk6IEFycmF5PHtcbiAgICAgICAgICBlbmREYXRlOiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICAgIHRvdGFsUmV2ZW51ZT86IHsgcmF3OiBudW1iZXI7IGZtdDogc3RyaW5nIH07XG4gICAgICAgICAgbmV0SW5jb21lPzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgICBvcGVyYXRpbmdJbmNvbWU/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICAgIGdyb3NzUHJvZml0PzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgfT47XG4gICAgICB9O1xuICAgICAgY2FzaGZsb3dTdGF0ZW1lbnRIaXN0b3J5Pzoge1xuICAgICAgICBjYXNoZmxvd1N0YXRlbWVudHM6IEFycmF5PHtcbiAgICAgICAgICBlbmREYXRlOiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICAgIG9wZXJhdGluZ0Nhc2hmbG93PzogeyByYXc6IG51bWJlcjsgZm10OiBzdHJpbmcgfTtcbiAgICAgICAgICBmcmVlQ2FzaGZsb3c/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICAgIGNhcGl0YWxFeHBlbmRpdHVyZXM/OiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9O1xuICAgICAgICB9PjtcbiAgICAgIH07XG4gICAgfT47XG4gICAgZXJyb3I/OiB7XG4gICAgICBjb2RlOiBzdHJpbmc7XG4gICAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgIH07XG4gIH07XG59XG5cbmV4cG9ydCBjbGFzcyBZYWhvb0ZpbmFuY2VDbGllbnQge1xuICBwcml2YXRlIGNvbmZpZzogWWFob29GaW5hbmNlQ29uZmlnO1xuICBwcml2YXRlIGJhc2VVcmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFlhaG9vRmluYW5jZUNvbmZpZyA9IHt9KSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5iYXNlVXJsID0gY29uZmlnLmJhc2VVcmwgfHwgJ2h0dHBzOi8vcXVlcnkxLmZpbmFuY2UueWFob28uY29tL3YxMC9maW5hbmNlJztcbiAgfVxuXG4gIGFzeW5jIGdldFF1b3RlU3VtbWFyeShzeW1ib2w6IHN0cmluZyk6IFByb21pc2U8WWFob29RdW90ZVN1bW1hcnlSZXNwb25zZT4ge1xuICAgIGNvbnN0IG1vZHVsZXMgPSBbXG4gICAgICAnZmluYW5jaWFsRGF0YScsXG4gICAgICAnZGVmYXVsdEtleVN0YXRpc3RpY3MnLFxuICAgICAgJ3N1bW1hcnlEZXRhaWwnLFxuICAgICAgJ2JhbGFuY2VTaGVldEhpc3RvcnknLFxuICAgICAgJ2luY29tZVN0YXRlbWVudEhpc3RvcnknLFxuICAgICAgJ2Nhc2hmbG93U3RhdGVtZW50SGlzdG9yeScsXG4gICAgXS5qb2luKCcsJyk7XG5cbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJhc2VVcmx9L3F1b3RlU3VtbWFyeS8ke3N5bWJvbH0/bW9kdWxlcz0ke21vZHVsZXN9YDtcbiAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdCh1cmwpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29tcGFueUZpbmFuY2lhbHMoc3ltYm9sOiBzdHJpbmcpOiBQcm9taXNlPFBhcnRpYWw8UXVhcnRlcmx5RmluYW5jaWFscz5bXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBxdW90ZVN1bW1hcnkgPSBhd2FpdCB0aGlzLmdldFF1b3RlU3VtbWFyeShzeW1ib2wpO1xuICAgICAgXG4gICAgICBpZiAocXVvdGVTdW1tYXJ5LnF1b3RlU3VtbWFyeS5lcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFlhaG9vIEZpbmFuY2UgQVBJIEVycm9yOiAke3F1b3RlU3VtbWFyeS5xdW90ZVN1bW1hcnkuZXJyb3IuZGVzY3JpcHRpb259YCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLmV4dHJhY3RGaW5hbmNpYWxEYXRhKHF1b3RlU3VtbWFyeSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGZldGNoaW5nIFlhaG9vIEZpbmFuY2UgZGF0YSBmb3IgJHtzeW1ib2x9OmAsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGZldGNoIGZpbmFuY2lhbCBkYXRhIGZyb20gWWFob28gRmluYW5jZTogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG1ha2VSZXF1ZXN0KHVybDogc3RyaW5nKTogUHJvbWlzZTxZYWhvb1F1b3RlU3VtbWFyeVJlc3BvbnNlPiB7XG4gICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTtcbiAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgdGhpcy5jb25maWcudGltZW91dCB8fCAxMDAwMCk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdVc2VyLUFnZW50JzogJ01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS85MS4wLjQ0NzIuMTI0IFNhZmFyaS81MzcuMzYnLFxuICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG5cbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBIVFRQICR7cmVzcG9uc2Uuc3RhdHVzfTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgcmV0dXJuIGRhdGEgYXMgWWFob29RdW90ZVN1bW1hcnlSZXNwb25zZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnJvci5uYW1lID09PSAnQWJvcnRFcnJvcicpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IHRpbWVvdXQnKTtcbiAgICAgIH1cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdEZpbmFuY2lhbERhdGEocXVvdGVTdW1tYXJ5OiBZYWhvb1F1b3RlU3VtbWFyeVJlc3BvbnNlKTogUGFydGlhbDxRdWFydGVybHlGaW5hbmNpYWxzPltdIHtcbiAgICBjb25zdCByZXN1bHQgPSBxdW90ZVN1bW1hcnkucXVvdGVTdW1tYXJ5LnJlc3VsdFswXTtcbiAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbmFuY2lhbHM6IFBhcnRpYWw8UXVhcnRlcmx5RmluYW5jaWFscz5bXSA9IFtdO1xuXG4gICAgLy8gR2V0IGN1cnJlbnQgcXVhcnRlciBkYXRhIGZyb20gZmluYW5jaWFsRGF0YVxuICAgIGlmIChyZXN1bHQuZmluYW5jaWFsRGF0YSkge1xuICAgICAgY29uc3QgY3VycmVudFF1YXJ0ZXI6IFBhcnRpYWw8UXVhcnRlcmx5RmluYW5jaWFscz4gPSB7XG4gICAgICAgIHF1YXJ0ZXI6IHRoaXMuZ2V0Q3VycmVudFF1YXJ0ZXIoKSxcbiAgICAgICAgcmVwb3J0RGF0ZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF0sXG4gICAgICAgIHRvdGFsUmV2ZW51ZTogdGhpcy5leHRyYWN0VmFsdWUocmVzdWx0LmZpbmFuY2lhbERhdGEudG90YWxSZXZlbnVlKSxcbiAgICAgICAgbmV0U2FsZXM6IHRoaXMuZXh0cmFjdFZhbHVlKHJlc3VsdC5maW5hbmNpYWxEYXRhLnRvdGFsUmV2ZW51ZSksXG4gICAgICAgIG5ldEluY29tZTogdGhpcy5leHRyYWN0VmFsdWUocmVzdWx0LmZpbmFuY2lhbERhdGEubmV0SW5jb21lVG9Db21tb24pLFxuICAgICAgICBmcmVlQ2FzaEZsb3c6IHRoaXMuZXh0cmFjdFZhbHVlKHJlc3VsdC5maW5hbmNpYWxEYXRhLmZyZWVDYXNoZmxvdyksXG4gICAgICB9O1xuXG4gICAgICBpZiAocmVzdWx0LmRlZmF1bHRLZXlTdGF0aXN0aWNzKSB7XG4gICAgICAgIGN1cnJlbnRRdWFydGVyLmVwcyA9IHRoaXMuZXh0cmFjdFZhbHVlKHJlc3VsdC5kZWZhdWx0S2V5U3RhdGlzdGljcy50cmFpbGluZ0Vwcyk7XG4gICAgICAgIGN1cnJlbnRRdWFydGVyLnNoYXJlc091dHN0YW5kaW5nID0gdGhpcy5leHRyYWN0VmFsdWUocmVzdWx0LmRlZmF1bHRLZXlTdGF0aXN0aWNzLnNoYXJlc091dHN0YW5kaW5nKTtcbiAgICAgIH1cblxuICAgICAgZmluYW5jaWFscy5wdXNoKGN1cnJlbnRRdWFydGVyKTtcbiAgICB9XG5cbiAgICAvLyBFeHRyYWN0IGhpc3RvcmljYWwgZGF0YSBmcm9tIGluY29tZSBzdGF0ZW1lbnRzXG4gICAgaWYgKHJlc3VsdC5pbmNvbWVTdGF0ZW1lbnRIaXN0b3J5Py5pbmNvbWVTdGF0ZW1lbnRIaXN0b3J5KSB7XG4gICAgICBmb3IgKGNvbnN0IHN0YXRlbWVudCBvZiByZXN1bHQuaW5jb21lU3RhdGVtZW50SGlzdG9yeS5pbmNvbWVTdGF0ZW1lbnRIaXN0b3J5LnNsaWNlKDAsIDQpKSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShzdGF0ZW1lbnQuZW5kRGF0ZS5yYXcgKiAxMDAwKTtcbiAgICAgICAgY29uc3QgcXVhcnRlcjogUGFydGlhbDxRdWFydGVybHlGaW5hbmNpYWxzPiA9IHtcbiAgICAgICAgICBxdWFydGVyOiB0aGlzLmRhdGVUb1F1YXJ0ZXIoZGF0ZSksXG4gICAgICAgICAgcmVwb3J0RGF0ZTogZGF0ZS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF0sXG4gICAgICAgICAgdG90YWxSZXZlbnVlOiB0aGlzLmV4dHJhY3RWYWx1ZShzdGF0ZW1lbnQudG90YWxSZXZlbnVlKSxcbiAgICAgICAgICBuZXRTYWxlczogdGhpcy5leHRyYWN0VmFsdWUoc3RhdGVtZW50LnRvdGFsUmV2ZW51ZSksXG4gICAgICAgICAgbmV0SW5jb21lOiB0aGlzLmV4dHJhY3RWYWx1ZShzdGF0ZW1lbnQubmV0SW5jb21lKSxcbiAgICAgICAgICBvcGVyYXRpbmdJbmNvbWU6IHRoaXMuZXh0cmFjdFZhbHVlKHN0YXRlbWVudC5vcGVyYXRpbmdJbmNvbWUpLFxuICAgICAgICB9O1xuXG4gICAgICAgIGZpbmFuY2lhbHMucHVzaChxdWFydGVyKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBNZXJnZSB3aXRoIGJhbGFuY2Ugc2hlZXQgZGF0YVxuICAgIGlmIChyZXN1bHQuYmFsYW5jZVNoZWV0SGlzdG9yeT8uYmFsYW5jZVNoZWV0U3RhdGVtZW50cykge1xuICAgICAgY29uc3QgYmFsYW5jZU1hcCA9IG5ldyBNYXAoXG4gICAgICAgIHJlc3VsdC5iYWxhbmNlU2hlZXRIaXN0b3J5LmJhbGFuY2VTaGVldFN0YXRlbWVudHMubWFwKHN0YXRlbWVudCA9PiBbXG4gICAgICAgICAgc3RhdGVtZW50LmVuZERhdGUucmF3LFxuICAgICAgICAgIHN0YXRlbWVudCxcbiAgICAgICAgXSlcbiAgICAgICk7XG5cbiAgICAgIGZpbmFuY2lhbHMuZm9yRWFjaChmaW5hbmNpYWwgPT4ge1xuICAgICAgICBpZiAoZmluYW5jaWFsLnJlcG9ydERhdGUpIHtcbiAgICAgICAgICBjb25zdCB0aW1lc3RhbXAgPSBNYXRoLmZsb29yKG5ldyBEYXRlKGZpbmFuY2lhbC5yZXBvcnREYXRlKS5nZXRUaW1lKCkgLyAxMDAwKTtcbiAgICAgICAgICBjb25zdCBiYWxhbmNlU2hlZXQgPSBiYWxhbmNlTWFwLmdldCh0aW1lc3RhbXApO1xuICAgICAgICAgIFxuICAgICAgICAgIGlmIChiYWxhbmNlU2hlZXQpIHtcbiAgICAgICAgICAgIGZpbmFuY2lhbC50b3RhbEFzc2V0cyA9IHRoaXMuZXh0cmFjdFZhbHVlKGJhbGFuY2VTaGVldC50b3RhbEFzc2V0cyk7XG4gICAgICAgICAgICBmaW5hbmNpYWwudG90YWxEZWJ0ID0gdGhpcy5leHRyYWN0VmFsdWUoYmFsYW5jZVNoZWV0LnNob3J0TG9uZ1Rlcm1EZWJ0KTtcbiAgICAgICAgICAgIGZpbmFuY2lhbC5zaGFyZWhvbGRlckVxdWl0eSA9IHRoaXMuZXh0cmFjdFZhbHVlKGJhbGFuY2VTaGVldC50b3RhbFN0b2NraG9sZGVyRXF1aXR5KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIE1lcmdlIHdpdGggY2FzaCBmbG93IGRhdGFcbiAgICBpZiAocmVzdWx0LmNhc2hmbG93U3RhdGVtZW50SGlzdG9yeT8uY2FzaGZsb3dTdGF0ZW1lbnRzKSB7XG4gICAgICBjb25zdCBjYXNoRmxvd01hcCA9IG5ldyBNYXAoXG4gICAgICAgIHJlc3VsdC5jYXNoZmxvd1N0YXRlbWVudEhpc3RvcnkuY2FzaGZsb3dTdGF0ZW1lbnRzLm1hcChzdGF0ZW1lbnQgPT4gW1xuICAgICAgICAgIHN0YXRlbWVudC5lbmREYXRlLnJhdyxcbiAgICAgICAgICBzdGF0ZW1lbnQsXG4gICAgICAgIF0pXG4gICAgICApO1xuXG4gICAgICBmaW5hbmNpYWxzLmZvckVhY2goZmluYW5jaWFsID0+IHtcbiAgICAgICAgaWYgKGZpbmFuY2lhbC5yZXBvcnREYXRlKSB7XG4gICAgICAgICAgY29uc3QgdGltZXN0YW1wID0gTWF0aC5mbG9vcihuZXcgRGF0ZShmaW5hbmNpYWwucmVwb3J0RGF0ZSkuZ2V0VGltZSgpIC8gMTAwMCk7XG4gICAgICAgICAgY29uc3QgY2FzaEZsb3cgPSBjYXNoRmxvd01hcC5nZXQodGltZXN0YW1wKTtcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAoY2FzaEZsb3cpIHtcbiAgICAgICAgICAgIGZpbmFuY2lhbC5mcmVlQ2FzaEZsb3cgPSB0aGlzLmV4dHJhY3RWYWx1ZShjYXNoRmxvdy5mcmVlQ2FzaGZsb3cpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbmFuY2lhbHMuZmlsdGVyKGYgPT4gZi50b3RhbFJldmVudWUgJiYgZi50b3RhbFJldmVudWUgPiAwKS5zbGljZSgwLCA4KTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdFZhbHVlKGZpZWxkOiB7IHJhdzogbnVtYmVyOyBmbXQ6IHN0cmluZyB9IHwgdW5kZWZpbmVkKTogbnVtYmVyIHtcbiAgICByZXR1cm4gZmllbGQ/LnJhdyB8fCAwO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50UXVhcnRlcigpOiBzdHJpbmcge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgeWVhciA9IG5vdy5nZXRGdWxsWWVhcigpO1xuICAgIGNvbnN0IG1vbnRoID0gbm93LmdldE1vbnRoKCkgKyAxO1xuICAgIGNvbnN0IHF1YXJ0ZXIgPSBNYXRoLmNlaWwobW9udGggLyAzKTtcbiAgICByZXR1cm4gYCR7eWVhcn0tUSR7cXVhcnRlcn1gO1xuICB9XG5cbiAgcHJpdmF0ZSBkYXRlVG9RdWFydGVyKGRhdGU6IERhdGUpOiBzdHJpbmcge1xuICAgIGNvbnN0IHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgY29uc3QgbW9udGggPSBkYXRlLmdldE1vbnRoKCkgKyAxO1xuICAgIGNvbnN0IHF1YXJ0ZXIgPSBNYXRoLmNlaWwobW9udGggLyAzKTtcbiAgICByZXR1cm4gYCR7eWVhcn0tUSR7cXVhcnRlcn1gO1xuICB9XG59Il19