"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const TABLE_NAME = process.env.TABLE_NAME;
const handler = async (event) => {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'OPTIONS,POST,GET',
    };
    try {
        const { httpMethod, queryStringParameters } = event;
        if (httpMethod !== 'GET') {
            return {
                statusCode: 405,
                headers,
                body: JSON.stringify({ error: 'Method not allowed' }),
            };
        }
        const { q: query, limit = '10', sector, minMarketCap, maxMarketCap } = queryStringParameters || {};
        if (!query) {
            return {
                statusCode: 400,
                headers,
                body: JSON.stringify({
                    success: false,
                    error: 'Query parameter "q" is required',
                    timestamp: new Date().toISOString(),
                }),
            };
        }
        const searchOptions = {
            limit: Math.min(parseInt(limit), 50),
            sector,
            minMarketCap: minMarketCap ? parseFloat(minMarketCap) : undefined,
            maxMarketCap: maxMarketCap ? parseFloat(maxMarketCap) : undefined,
        };
        const results = await searchCompanies(query, searchOptions);
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                data: results,
                query,
                filters: searchOptions,
                timestamp: new Date().toISOString(),
            }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function searchCompanies(query, options) {
    const normalizedQuery = query.toLowerCase().trim();
    const results = [];
    try {
        // Strategy 1: Exact ticker match
        const exactMatch = await searchByTicker(query.toUpperCase());
        if (exactMatch) {
            results.push({ ...exactMatch, relevanceScore: 1.0, matchType: 'exact_ticker' });
        }
        // Strategy 2: Fuzzy name search using scan (not ideal for production)
        if (results.length < options.limit) {
            const nameMatches = await searchByName(normalizedQuery, options.limit - results.length);
            results.push(...nameMatches.map(item => ({ ...item, matchType: 'name_match' })));
        }
        // Strategy 3: Sector-based search if sector filter is provided
        if (options.sector && results.length < options.limit) {
            const sectorMatches = await searchBySector(options.sector, options.limit - results.length);
            results.push(...sectorMatches.map(item => ({ ...item, matchType: 'sector_match' })));
        }
        // Apply filters
        let filteredResults = results;
        if (options.minMarketCap || options.maxMarketCap) {
            filteredResults = results.filter(item => {
                const marketCap = item.marketCap || 0;
                if (options.minMarketCap && marketCap < options.minMarketCap)
                    return false;
                if (options.maxMarketCap && marketCap > options.maxMarketCap)
                    return false;
                return true;
            });
        }
        if (options.sector) {
            filteredResults = filteredResults.filter(item => item.sector?.toLowerCase().includes(options.sector.toLowerCase()));
        }
        // Remove duplicates and sort by relevance
        const uniqueResults = Array.from(new Map(filteredResults.map(item => [item.ticker, item])).values());
        return uniqueResults
            .sort((a, b) => (b.relevanceScore || 0) - (a.relevanceScore || 0))
            .slice(0, options.limit);
    }
    catch (error) {
        console.error('Error in searchCompanies:', error);
        return [];
    }
}
async function searchByTicker(ticker) {
    try {
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: TABLE_NAME,
            KeyConditionExpression: 'PK = :pk AND SK = :sk',
            ExpressionAttributeValues: {
                ':pk': `COMPANY#${ticker}`,
                ':sk': 'METADATA',
            },
            Limit: 1,
        });
        const result = await docClient.send(command);
        if (result.Items && result.Items.length > 0) {
            const item = result.Items[0];
            return {
                id: item.ticker,
                name: item.name,
                ticker: item.ticker,
                sector: item.sector,
                marketCap: item.marketCap,
                description: item.description,
                lastUpdated: item.lastUpdated,
            };
        }
        return null;
    }
    catch (error) {
        console.error('Error in searchByTicker:', error);
        return null;
    }
}
async function searchByName(query, limit) {
    try {
        // Use scan with filter for name search (not ideal for production)
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: TABLE_NAME,
            FilterExpression: 'SK = :sk AND (contains(#name, :query) OR contains(ticker, :upperQuery))',
            ExpressionAttributeNames: {
                '#name': 'name',
            },
            ExpressionAttributeValues: {
                ':sk': 'METADATA',
                ':query': query,
                ':upperQuery': query.toUpperCase(),
            },
            Limit: limit * 2, // Get more to account for filtering
        });
        const result = await docClient.send(command);
        return (result.Items || []).map(item => {
            // Calculate relevance score based on match quality
            const name = (item.name || '').toLowerCase();
            const ticker = (item.ticker || '').toLowerCase();
            let relevanceScore = 0;
            if (ticker === query) {
                relevanceScore = 0.9;
            }
            else if (ticker.includes(query)) {
                relevanceScore = 0.8;
            }
            else if (name.startsWith(query)) {
                relevanceScore = 0.7;
            }
            else if (name.includes(query)) {
                relevanceScore = 0.6;
            }
            else {
                relevanceScore = 0.3;
            }
            return {
                id: item.ticker,
                name: item.name,
                ticker: item.ticker,
                sector: item.sector,
                marketCap: item.marketCap,
                description: item.description,
                lastUpdated: item.lastUpdated,
                relevanceScore,
            };
        }).slice(0, limit);
    }
    catch (error) {
        console.error('Error in searchByName:', error);
        return [];
    }
}
async function searchBySector(sector, limit) {
    try {
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: TABLE_NAME,
            IndexName: 'GSI1',
            KeyConditionExpression: 'GSI1PK = :sector',
            ExpressionAttributeValues: {
                ':sector': `SECTOR#${sector}`,
            },
            Limit: limit,
        });
        const result = await docClient.send(command);
        return (result.Items || []).map(item => ({
            id: item.ticker,
            name: item.name,
            ticker: item.ticker,
            sector: item.sector,
            marketCap: item.marketCap,
            description: item.description,
            lastUpdated: item.lastUpdated,
            relevanceScore: 0.4, // Lower relevance for sector matches
        }));
    }
    catch (error) {
        console.error('Error in searchBySector:', error);
        return [];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VhcmNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3REFBMEY7QUFFMUYsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUV0RCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVcsQ0FBQztBQUVwQyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTJCLEVBQ0ssRUFBRTtJQUNsQyxNQUFNLE9BQU8sR0FBRztRQUNkLGNBQWMsRUFBRSxrQkFBa0I7UUFDbEMsNkJBQTZCLEVBQUUsR0FBRztRQUNsQyw4QkFBOEIsRUFBRSxjQUFjO1FBQzlDLDhCQUE4QixFQUFFLGtCQUFrQjtLQUNuRCxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0gsTUFBTSxFQUFFLFVBQVUsRUFBRSxxQkFBcUIsRUFBRSxHQUFHLEtBQUssQ0FBQztRQUVwRCxJQUFJLFVBQVUsS0FBSyxLQUFLLEVBQUUsQ0FBQztZQUN6QixPQUFPO2dCQUNMLFVBQVUsRUFBRSxHQUFHO2dCQUNmLE9BQU87Z0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQzthQUN0RCxDQUFDO1FBQ0osQ0FBQztRQUVELE1BQU0sRUFDSixDQUFDLEVBQUUsS0FBSyxFQUNSLEtBQUssR0FBRyxJQUFJLEVBQ1osTUFBTSxFQUNOLFlBQVksRUFDWixZQUFZLEVBQ2IsR0FBSSxxQkFBZ0QsSUFBSSxFQUFFLENBQUM7UUFFNUQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ1gsT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztnQkFDZixPQUFPO2dCQUNQLElBQUksRUFBRSxJQUFJLENB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SyxVQUFVLGNBQWMsQ0FBQyxNQUFjLEVBQUUsS0FBYTtJQUN6RCxJQUFJLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLDJCQUFZLENBQUM7WUFDL0IsU0FBUyxFQUFFLFVBQVU7WUFDckIsU0FBUyxFQUFFLE1BQU07WUFDakIsc0JBQXNCLEVBQUUsa0JBQWtCO1lBQzFDLHlCQUF5QixFQUFFO2dCQUN6QixTQUFTLEVBQUUsVUFBVSxNQUFNLEVBQUU7YUFDOUI7WUFDRCxLQUFLLEVBQUUsS0FBSztTQUNiLENBQUMsQ0FBQztRQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU3QyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZDLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTTtZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtZQUNuQixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztZQUM3QixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsY0FBYyxFQUFFLEdBQUcsRUFBRSxxQ0FBcUM7U0FDM0QsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakQsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCwgU2NhbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGNsaWVudCk7XG5cbmNvbnN0IFRBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5UQUJMRV9OQU1FITtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc3QgaGVhZGVycyA9IHtcbiAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdPUFRJT05TLFBPU1QsR0VUJyxcbiAgfTtcblxuICB0cnkge1xuICAgIGNvbnN0IHsgaHR0cE1ldGhvZCwgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzIH0gPSBldmVudDtcblxuICAgIGlmIChodHRwTWV0aG9kICE9PSAnR0VUJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDA1LFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTWV0aG9kIG5vdCBhbGxvd2VkJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgeyBcbiAgICAgIHE6IHF1ZXJ5LCBcbiAgICAgIGxpbWl0ID0gJzEwJywgXG4gICAgICBzZWN0b3IsXG4gICAgICBtaW5NYXJrZXRDYXAsXG4gICAgICBtYXhNYXJrZXRDYXAgXG4gICAgfSA9IChxdWVyeVN0cmluZ1BhcmFtZXRlcnMgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPikgfHwge307XG5cbiAgICBpZiAoIXF1ZXJ5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgXG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdRdWVyeSBwYXJhbWV0ZXIgXCJxXCIgaXMgcmVxdWlyZWQnLFxuICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3Qgc2VhcmNoT3B0aW9ucyA9IHtcbiAgICAgIGxpbWl0OiBNYXRoLm1pbihwYXJzZUludChsaW1pdCksIDUwKSxcbiAgICAgIHNlY3RvcixcbiAgICAgIG1pbk1hcmtldENhcDogbWluTWFya2V0Q2FwID8gcGFyc2VGbG9hdChtaW5NYXJrZXRDYXApIDogdW5kZWZpbmVkLFxuICAgICAgbWF4TWFya2V0Q2FwOiBtYXhNYXJrZXRDYXAgPyBwYXJzZUZsb2F0KG1heE1hcmtldENhcCkgOiB1bmRlZmluZWQsXG4gICAgfTtcblxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBzZWFyY2hDb21wYW5pZXMocXVlcnksIHNlYXJjaE9wdGlvbnMpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHJlc3VsdHMsXG4gICAgICAgIHF1ZXJ5LFxuICAgICAgICBmaWx0ZXJzOiBzZWFyY2hPcHRpb25zLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcblxuaW50ZXJmYWNlIFNlYXJjaE9wdGlvbnMge1xuICBsaW1pdDogbnVtYmVyO1xuICBzZWN0b3I/OiBzdHJpbmc7XG4gIG1pbk1hcmtldENhcD86IG51bWJlcjtcbiAgbWF4TWFya2V0Q2FwPzogbnVtYmVyO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZWFyY2hDb21wYW5pZXMocXVlcnk6IHN0cmluZywgb3B0aW9uczogU2VhcmNoT3B0aW9ucykge1xuICBjb25zdCBub3JtYWxpemVkUXVlcnkgPSBxdWVyeS50b0xvd2VyQ2FzZSgpLnRyaW0oKTtcbiAgY29uc3QgcmVzdWx0czogYW55W10gPSBbXTtcbiAgXG4gIHRyeSB7XG4gICAgLy8gU3RyYXRlZ3kgMTogRXhhY3QgdGlja2VyIG1hdGNoXG4gICAgY29uc3QgZXhhY3RNYXRjaCA9IGF3YWl0IHNlYXJjaEJ5VGlja2VyKHF1ZXJ5LnRvVXBwZXJDYXNlKCkpO1xuICAgIGlmIChleGFjdE1hdGNoKSB7XG4gICAgICByZXN1bHRzLnB1c2goeyAuLi5leGFjdE1hdGNoLCByZWxldmFuY2VTY29yZTogMS4wLCBtYXRjaFR5cGU6ICdleGFjdF90aWNrZXInIH0pO1xuICAgIH1cblxuICAgIC8vIFN0cmF0ZWd5IDI6IEZ1enp5IG5hbWUgc2VhcmNoIHVzaW5nIHNjYW4gKG5vdCBpZGVhbCBmb3IgcHJvZHVjdGlvbilcbiAgICBpZiAocmVzdWx0cy5sZW5ndGggPCBvcHRpb25zLmxpbWl0KSB7XG4gICAgICBjb25zdCBuYW1lTWF0Y2hlcyA9IGF3YWl0IHNlYXJjaEJ5TmFtZShub3JtYWxpemVkUXVlcnksIG9wdGlvbnMubGltaXQgLSByZXN1bHRzLmxlbmd0aCk7XG4gICAgICByZXN1bHRzLnB1c2goLi4ubmFtZU1hdGNoZXMubWFwKGl0ZW0gPT4gKHsgLi4uaXRlbSwgbWF0Y2hUeXBlOiAnbmFtZV9tYXRjaCcgfSkpKTtcbiAgICB9XG5cbiAgICAvLyBTdHJhdGVneSAzOiBTZWN0b3ItYmFzZWQgc2VhcmNoIGlmIHNlY3RvciBmaWx0ZXIgaXMgcHJvdmlkZWRcbiAgICBpZiAob3B0aW9ucy5zZWN0b3IgJiYgcmVzdWx0cy5sZW5ndGggPCBvcHRpb25zLmxpbWl0KSB7XG4gICAgICBjb25zdCBzZWN0b3JNYXRjaGVzID0gYXdhaXQgc2VhcmNoQnlTZWN0b3Iob3B0aW9ucy5zZWN0b3IsIG9wdGlvbnMubGltaXQgLSByZXN1bHRzLmxlbmd0aCk7XG4gICAgICByZXN1bHRzLnB1c2goLi4uc2VjdG9yTWF0Y2hlcy5tYXAoaXRlbSA9PiAoeyAuLi5pdGVtLCBtYXRjaFR5cGU6ICdzZWN0b3JfbWF0Y2gnIH0pKSk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgZmlsdGVyc1xuICAgIGxldCBmaWx0ZXJlZFJlc3VsdHMgPSByZXN1bHRzO1xuICAgIFxuICAgIGlmIChvcHRpb25zLm1pbk1hcmtldENhcCB8fCBvcHRpb25zLm1heE1hcmtldENhcCkge1xuICAgICAgZmlsdGVyZWRSZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICAgIGNvbnN0IG1hcmtldENhcCA9IGl0ZW0ubWFya2V0Q2FwIHx8IDA7XG4gICAgICAgIGlmIChvcHRpb25zLm1pbk1hcmtldENhcCAmJiBtYXJrZXRDYXAgPCBvcHRpb25zLm1pbk1hcmtldENhcCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBpZiAob3B0aW9ucy5tYXhNYXJrZXRDYXAgJiYgbWFya2V0Q2FwID4gb3B0aW9ucy5tYXhNYXJrZXRDYXApIHJldHVybiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5zZWN0b3IpIHtcbiAgICAgIGZpbHRlcmVkUmVzdWx0cyA9IGZpbHRlcmVkUmVzdWx0cy5maWx0ZXIoaXRlbSA9PiBcbiAgICAgICAgaXRlbS5zZWN0b3I/LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMob3B0aW9ucy5zZWN0b3IhLnRvTG93ZXJDYXNlKCkpXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGFuZCBzb3J0IGJ5IHJlbGV2YW5jZVxuICAgIGNvbnN0IHVuaXF1ZVJlc3VsdHMgPSBBcnJheS5mcm9tKFxuICAgICAgbmV3IE1hcChmaWx0ZXJlZFJlc3VsdHMubWFwKGl0ZW0gPT4gW2l0ZW0udGlja2VyLCBpdGVtXSkpLnZhbHVlcygpXG4gICAgKTtcblxuICAgIHJldHVybiB1bmlxdWVSZXN1bHRzXG4gICAgICAuc29ydCgoYSwgYikgPT4gKGIucmVsZXZhbmNlU2NvcmUgfHwgMCkgLSAoYS5yZWxldmFuY2VTY29yZSB8fCAwKSlcbiAgICAgIC5zbGljZSgwLCBvcHRpb25zLmxpbWl0KTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIHNlYXJjaENvbXBhbmllczonLCBlcnJvcik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaEJ5VGlja2VyKHRpY2tlcjogc3RyaW5nKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBUQUJMRV9OQU1FLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ1BLID0gOnBrIEFORCBTSyA9IDpzaycsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6cGsnOiBgQ09NUEFOWSMke3RpY2tlcn1gLFxuICAgICAgICAnOnNrJzogJ01FVEFEQVRBJyxcbiAgICAgIH0sXG4gICAgICBMaW1pdDogMSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIFxuICAgIGlmIChyZXN1bHQuSXRlbXMgJiYgcmVzdWx0Lkl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSByZXN1bHQuSXRlbXNbMF07XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogaXRlbS50aWNrZXIsXG4gICAgICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICAgICAgdGlja2VyOiBpdGVtLnRpY2tlcixcbiAgICAgICAgc2VjdG9yOiBpdGVtLnNlY3RvcixcbiAgICAgICAgbWFya2V0Q2FwOiBpdGVtLm1hcmtldENhcCxcbiAgICAgICAgZGVzY3JpcHRpb246IGl0ZW0uZGVzY3JpcHRpb24sXG4gICAgICAgIGxhc3RVcGRhdGVkOiBpdGVtLmxhc3RVcGRhdGVkLFxuICAgICAgfTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIG51bGw7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gc2VhcmNoQnlUaWNrZXI6JywgZXJyb3IpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaEJ5TmFtZShxdWVyeTogc3RyaW5nLCBsaW1pdDogbnVtYmVyKSB7XG4gIHRyeSB7XG4gICAgLy8gVXNlIHNjYW4gd2l0aCBmaWx0ZXIgZm9yIG5hbWUgc2VhcmNoIChub3QgaWRlYWwgZm9yIHByb2R1Y3Rpb24pXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICBGaWx0ZXJFeHByZXNzaW9uOiAnU0sgPSA6c2sgQU5EIChjb250YWlucygjbmFtZSwgOnF1ZXJ5KSBPUiBjb250YWlucyh0aWNrZXIsIDp1cHBlclF1ZXJ5KSknLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjbmFtZSc6ICduYW1lJyxcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6c2snOiAnTUVUQURBVEEnLFxuICAgICAgICAnOnF1ZXJ5JzogcXVlcnksXG4gICAgICAgICc6dXBwZXJRdWVyeSc6IHF1ZXJ5LnRvVXBwZXJDYXNlKCksXG4gICAgICB9LFxuICAgICAgTGltaXQ6IGxpbWl0ICogMiwgLy8gR2V0IG1vcmUgdG8gYWNjb3VudCBmb3IgZmlsdGVyaW5nXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBcbiAgICByZXR1cm4gKHJlc3VsdC5JdGVtcyB8fCBbXSkubWFwKGl0ZW0gPT4ge1xuICAgICAgLy8gQ2FsY3VsYXRlIHJlbGV2YW5jZSBzY29yZSBiYXNlZCBvbiBtYXRjaCBxdWFsaXR5XG4gICAgICBjb25zdCBuYW1lID0gKGl0ZW0ubmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKTtcbiAgICAgIGNvbnN0IHRpY2tlciA9IChpdGVtLnRpY2tlciB8fCAnJykudG9Mb3dlckNhc2UoKTtcbiAgICAgIFxuICAgICAgbGV0IHJlbGV2YW5jZVNjb3JlID0gMDtcbiAgICAgIFxuICAgICAgaWYgKHRpY2tlciA9PT0gcXVlcnkpIHtcbiAgICAgICAgcmVsZXZhbmNlU2NvcmUgPSAwLjk7XG4gICAgICB9IGVsc2UgaWYgKHRpY2tlci5pbmNsdWRlcyhxdWVyeSkpIHtcbiAgICAgICAgcmVsZXZhbmNlU2NvcmUgPSAwLjg7XG4gICAgICB9IGVsc2UgaWYgKG5hbWUuc3RhcnRzV2l0aChxdWVyeSkpIHtcbiAgICAgICAgcmVsZXZhbmNlU2NvcmUgPSAwLjc7XG4gICAgICB9IGVsc2UgaWYgKG5hbWUuaW5jbHVkZXMocXVlcnkpKSB7XG4gICAgICAgIHJlbGV2YW5jZVNjb3JlID0gMC42O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVsZXZhbmNlU2NvcmUgPSAwLjM7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBpdGVtLnRpY2tlcixcbiAgICAgICAgbmFtZTogaXRlbS5uYW1lLFxuICAgICAgICB0aWNrZXI6IGl0ZW0udGlja2VyLFxuICAgICAgICBzZWN0b3I6IGl0ZW0uc2VjdG9yLFxuICAgICAgICBtYXJrZXRDYXA6IGl0ZW0ubWFya2V0Q2FwLFxuICAgICAgICBkZXNjcmlwdGlvbjogaXRlbS5kZXNjcmlwdGlvbixcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IGl0ZW0ubGFzdFVwZGF0ZWQsXG4gICAgICAgIHJlbGV2YW5jZVNjb3JlLFxuICAgICAgfTtcbiAgICB9KS5zbGljZSgwLCBsaW1pdCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gc2VhcmNoQnlOYW1lOicsIGVycm9yKTtcbiAgICByZXR1cm4gW107XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VhcmNoQnlTZWN0b3Ioc2VjdG9yOiBzdHJpbmcsIGxpbWl0OiBudW1iZXIpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICBJbmRleE5hbWU6ICdHU0kxJyxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdHU0kxUEsgPSA6c2VjdG9yJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpzZWN0b3InOiBgU0VDVE9SIyR7c2VjdG9yfWAsXG4gICAgICB9LFxuICAgICAgTGltaXQ6IGxpbWl0LFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgXG4gICAgcmV0dXJuIChyZXN1bHQuSXRlbXMgfHwgW10pLm1hcChpdGVtID0+ICh7XG4gICAgICBpZDogaXRlbS50aWNrZXIsXG4gICAgICBuYW1lOiBpdGVtLm5hbWUsXG4gICAgICB0aWNrZXI6IGl0ZW0udGlja2VyLFxuICAgICAgc2VjdG9yOiBpdGVtLnNlY3RvcixcbiAgICAgIG1hcmtldENhcDogaXRlbS5tYXJrZXRDYXAsXG4gICAgICBkZXNjcmlwdGlvbjogaXRlbS5kZXNjcmlwdGlvbixcbiAgICAgIGxhc3RVcGRhdGVkOiBpdGVtLmxhc3RVcGRhdGVkLFxuICAgICAgcmVsZXZhbmNlU2NvcmU6IDAuNCwgLy8gTG93ZXIgcmVsZXZhbmNlIGZvciBzZWN0b3IgbWF0Y2hlc1xuICAgIH0pKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBzZWFyY2hCeVNlY3RvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59Il19