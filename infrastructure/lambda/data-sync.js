"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const data_aggregator_1 = require("./api-clients/data-aggregator");
const data_processor_1 = require("./data-processor");
const client = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const TABLE_NAME = process.env.TABLE_NAME;
const ALPHA_VANTAGE_API_KEY = process.env.ALPHA_VANTAGE_API_KEY;
const FMP_API_KEY = process.env.FMP_API_KEY;
const handler = async (event, context) => {
    console.log('Starting scheduled data sync...', { event, context });
    const startTime = Date.now();
    const results = [];
    const errors = [];
    try {
        // Initialize data aggregator
        const aggregatorConfig = {
            retryAttempts: 3,
            retryDelay: 2000,
        };
        if (ALPHA_VANTAGE_API_KEY) {
            aggregatorConfig.alphaVantage = {
                apiKey: ALPHA_VANTAGE_API_KEY,
                timeout: 15000,
            };
        }
        if (FMP_API_KEY) {
            aggregatorConfig.financialModelingPrep = {
                apiKey: FMP_API_KEY,
                timeout: 15000,
            };
        }
        aggregatorConfig.yahooFinance = {
            timeout: 10000,
        };
        const dataAggregator = new data_aggregator_1.DataAggregator(aggregatorConfig);
        const dataProcessor = new data_processor_1.DataProcessor(TABLE_NAME, dataAggregator);
        // Get list of companies to update
        const companies = await getCompaniesToUpdate();
        console.log(`Found ${companies.length} companies to update`);
        // Process companies in batches to avoid overwhelming APIs
        const batchSize = 5; // Process 5 companies at a time
        const batches = [];
        for (let i = 0; i < companies.length; i += batchSize) {
            batches.push(companies.slice(i, i + batchSize));
        }
        for (const batch of batches) {
            const batchPromises = batch.map(async (company) => {
                const jobStartTime = Date.now();
                try {
                    console.log(`Processing ${company.ticker}...`);
                    const result = await dataProcessor.processCompanyData(company.ticker, {
                        name: company.name,
                        sector: company.sector,
                        marketCap: company.marketCap,
                    });
                    const processingTime = Date.now() - jobStartTime;
                    const jobResult = {
                        symbol: company.ticker,
                        success: result.storageResult.success,
                        recordsUpdated: result.storageResult.recordsStored,
                        errors: [
                            ...result.storageResult.errors,
                            ...result.validationResults.flatMap(v => v.errors),
                        ],
                        qualityScore: result.qualityMetrics.overall,
                        processingTime,
                    };
                    // Update company's last sync timestamp
                    await updateLastSyncTime(company.ticker);
                    return jobResult;
                }
                catch (error) {
                    console.error(`Error processing ${company.ticker}:`, error);
                    return {
                        symbol: company.ticker,
                        success: false,
                        recordsUpdated: 0,
                        errors: [error instanceof Error ? error.message : 'Unknown error'],
                        qualityScore: 0,
                        processingTime: Date.now() - jobStartTime,
                    };
                }
            });
            // Wait for batch to complete
            const batchResults = await Promise.all(batchPromises);
            results.push(...batchResults);
            // Add delay between batches to respect API rate limits
            if (batches.indexOf(batch) < batches.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 5000)); // 5 second delay
            }
        }
        // Generate summary
        const summary = {
            totalCompanies: companies.length,
            successfulUpdates: results.filter(r => r.success).length,
            failedUpdates: results.filter(r => !r.success).length,
            totalRecordsUpdated: results.reduce((sum, r) => sum + r.recordsUpdated, 0),
            averageQualityScore: results.length > 0
                ? results.reduce((sum, r) => sum + r.qualityScore, 0) / results.length
                : 0,
            totalProcessingTime: Date.now() - startTime,
            errors: results.flatMap(r => r.errors),
        };
        // Log summary
        console.log('Data sync completed:', summary);
        // Store sync metrics for monitoring
        await storeSyncMetrics(summary, results);
        return summary;
    }
    catch (error) {
        console.error('Fatal error during data sync:', error);
        const errorSummary = {
            totalCompanies: 0,
            successfulUpdates: 0,
            failedUpdates: 0,
            totalRecordsUpdated: 0,
            averageQualityScore: 0,
            totalProcessingTime: Date.now() - startTime,
            errors: [error instanceof Error ? error.message : 'Unknown fatal error'],
        };
        await storeSyncMetrics(errorSummary, []);
        throw error;
    }
};
exports.handler = handler;
async function getCompaniesToUpdate() {
    try {
        // Get all companies from DynamoDB
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: TABLE_NAME,
            FilterExpression: 'SK = :sk',
            ExpressionAttributeValues: {
                ':sk': 'METADATA',
            },
            ProjectionExpression: 'ticker, #name, sector, marketCap, lastUpdated',
            ExpressionAttributeNames: {
                '#name': 'name', // 'name' is a reserved word in DynamoDB
            },
        });
        const result = await docClient.send(command);
        const companies = (result.Items || []).map(item => ({
            ticker: item.ticker,
            name: item.name || item.ticker,
            sector: item.sector || 'Unknown',
            marketCap: item.marketCap || 0,
            lastUpdated: item.lastUpdated,
        }));
        // If no companies exist, return a default list of popular companies
        if (companies.length === 0) {
            return getDefaultCompanies();
        }
        // Sort by last updated (oldest first) and market cap (largest first)
        return companies.sort((a, b) => {
            const aLastUpdated = new Date(a.lastUpdated || '1970-01-01').getTime();
            const bLastUpdated = new Date(b.lastUpdated || '1970-01-01').getTime();
            if (aLastUpdated !== bLastUpdated) {
                return aLastUpdated - bLastUpdated; // Oldest first
            }
            return b.marketCap - a.marketCap; // Largest market cap first
        });
    }
    catch (error) {
        console.error('Error getting companies to update:', error);
        return getDefaultCompanies();
    }
}
function getDefaultCompanies() {
    return [
        { ticker: 'AAPL', name: 'Apple Inc.', sector: 'Technology', marketCap: 3000000000000 },
        { ticker: 'MSFT', name: 'Microsoft Corporation', sector: 'Technology', marketCap: 2800000000000 },
        { ticker: 'GOOGL', name: 'Alphabet Inc.', sector: 'Technology', marketCap: 1700000000000 },
        { ticker: 'AMZN', name: 'Amazon.com Inc.', sector: 'Consumer Discretionary', marketCap: 1500000000000 },
        { ticker: 'TSLA', name: 'Tesla Inc.', sector: 'Consumer Discretionary', marketCap: 800000000000 },
        { ticker: 'META', name: 'Meta Platforms Inc.', sector: 'Technology', marketCap: 750000000000 },
        { ticker: 'NVDA', name: 'NVIDIA Corporation', sector: 'Technology', marketCap: 1800000000000 },
        { ticker: 'JPM', name: 'JPMorgan Chase & Co.', sector: 'Financial Services', marketCap: 500000000000 },
        { ticker: 'JNJ', name: 'Johnson & Johnson', sector: 'Healthcare', marketCap: 450000000000 },
        { ticker: 'V', name: 'Visa Inc.', sector: 'Financial Services', marketCap: 500000000000 },
    ];
}
async function updateLastSyncTime(ticker) {
    try {
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: TABLE_NAME,
            Item: {
                PK: `COMPANY#${ticker.toUpperCase()}`,
                SK: 'SYNC_METADATA',
                lastSyncTime: new Date().toISOString(),
                ticker: ticker.toUpperCase(),
            },
        }));
    }
    catch (error) {
        console.warn(`Failed to update sync time for ${ticker}:`, error);
    }
}
async function storeSyncMetrics(summary, results) {
    try {
        const timestamp = new Date().toISOString();
        const date = timestamp.split('T')[0];
        // Store daily summary
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: TABLE_NAME,
            Item: {
                PK: 'SYNC_METRICS',
                SK: `DAILY#${date}`,
                timestamp,
                ...summary,
            },
        }));
        // Store individual job results for detailed analysis
        const batchSize = 25;
        for (let i = 0; i < results.length; i += batchSize) {
            const batch = results.slice(i, i + batchSize);
            const putRequests = batch.map((result, index) => ({
                PutRequest: {
                    Item: {
                        PK: 'SYNC_METRICS',
                        SK: `JOB#${date}#${String(i + index).padStart(4, '0')}`,
                        timestamp,
                        ...result,
                    },
                },
            }));
            if (putRequests.length > 0) {
                await docClient.send(new lib_dynamodb_1.BatchWriteCommand({
                    RequestItems: {
                        [TABLE_NAME]: putRequests,
                    },
                }));
            }
        }
    }
    catch (error) {
        console.error('Error storing sync metrics:', error);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zeW5jLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGF0YS1zeW5jLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3REFBMkc7QUFDM0csbUVBQXFGO0FBQ3JGLHFEQUFpRDtBQUVqRCxNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBRXRELE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVyxDQUFDO0FBQzNDLE1BQU0scUJBQXFCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQztBQUNoRSxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztBQXFCckMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUErQyxFQUMvQyxPQUFnQixFQUNNLEVBQUU7SUFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBRW5FLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3QixNQUFNLE9BQU8sR0FBb0IsRUFBRSxDQUFDO0lBQ3BDLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztJQUU1QixJQUFJLENBQUM7UUFDSCw2QkFBNkI7UUFDN0IsTUFBTSxnQkFBZ0IsR0FBeUI7WUFDN0MsYUFBYSxFQUFFLENBQUM7WUFDaEIsVUFBVSxFQUFFLElBQUk7U0FDakIsQ0FBQztRQUVGLElBQUkscUJBQXFCLEVBQUUsQ0FBQztZQUMxQixnQkFBZ0IsQ0FBQyxZQUFZLEdBQUc7Z0JBQzlCLE1BQU0sRUFBRSxxQkFBcUI7Z0JBQzdCLE9BQU8sRUFBRSxLQUFLO2FBQ2YsQ0FBQztRQUNKLENBQUM7UUFFRCxJQUFJ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VjtpQkFDRjthQUNGLENBQUMsQ0FBQyxDQUFDO1lBRUosSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUMzQixNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxnQ0FBaUIsQ0FBQztvQkFDekMsWUFBWSxFQUFFO3dCQUNaLENBQUMsVUFBVSxDQUFDLEVBQUUsV0FBVztxQkFDMUI7aUJBQ0YsQ0FBQyxDQUFDLENBQUM7WUFDTixDQUFDO1FBQ0gsQ0FBQztJQUVILENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN0RCxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50QnJpZGdlRXZlbnQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFNjYW5Db21tYW5kLCBQdXRDb21tYW5kLCBCYXRjaFdyaXRlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBEYXRhQWdncmVnYXRvciwgRGF0YUFnZ3JlZ2F0b3JDb25maWcgfSBmcm9tICcuL2FwaS1jbGllbnRzL2RhdGEtYWdncmVnYXRvcic7XG5pbXBvcnQgeyBEYXRhUHJvY2Vzc29yIH0gZnJvbSAnLi9kYXRhLXByb2Nlc3Nvcic7XG5cbmNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oY2xpZW50KTtcblxuY29uc3QgVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LlRBQkxFX05BTUUhO1xuY29uc3QgQUxQSEFfVkFOVEFHRV9BUElfS0VZID0gcHJvY2Vzcy5lbnYuQUxQSEFfVkFOVEFHRV9BUElfS0VZO1xuY29uc3QgRk1QX0FQSV9LRVkgPSBwcm9jZXNzLmVudi5GTVBfQVBJX0tFWTtcblxuaW50ZXJmYWNlIFN5bmNKb2JSZXN1bHQge1xuICBzeW1ib2w6IHN0cmluZztcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgcmVjb3Jkc1VwZGF0ZWQ6IG51bWJlcjtcbiAgZXJyb3JzOiBzdHJpbmdbXTtcbiAgcXVhbGl0eVNjb3JlOiBudW1iZXI7XG4gIHByb2Nlc3NpbmdUaW1lOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBTeW5jU3VtbWFyeSB7XG4gIHRvdGFsQ29tcGFuaWVzOiBudW1iZXI7XG4gIHN1Y2Nlc3NmdWxVcGRhdGVzOiBudW1iZXI7XG4gIGZhaWxlZFVwZGF0ZXM6IG51bWJlcjtcbiAgdG90YWxSZWNvcmRzVXBkYXRlZDogbnVtYmVyO1xuICBhdmVyYWdlUXVhbGl0eVNjb3JlOiBudW1iZXI7XG4gIHRvdGFsUHJvY2Vzc2luZ1RpbWU6IG51bWJlcjtcbiAgZXJyb3JzOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBFdmVudEJyaWRnZUV2ZW50PCdTY2hlZHVsZWQgRXZlbnQnLCBhbnk+LFxuICBjb250ZXh0OiBDb250ZXh0XG4pOiBQcm9taXNlPFN5bmNTdW1tYXJ5PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdTdGFydGluZyBzY2hlZHVsZWQgZGF0YSBzeW5jLi4uJywgeyBldmVudCwgY29udGV4dCB9KTtcblxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICBjb25zdCByZXN1bHRzOiBTeW5jSm9iUmVzdWx0W10gPSBbXTtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIHRyeSB7XG4gICAgLy8gSW5pdGlhbGl6ZSBkYXRhIGFnZ3JlZ2F0b3JcbiAgICBjb25zdCBhZ2dyZWdhdG9yQ29uZmlnOiBEYXRhQWdncmVnYXRvckNvbmZpZyA9IHtcbiAgICAgIHJldHJ5QXR0ZW1wdHM6IDMsXG4gICAgICByZXRyeURlbGF5OiAyMDAwLFxuICAgIH07XG5cbiAgICBpZiAoQUxQSEFfVkFOVEFHRV9BUElfS0VZKSB7XG4gICAgICBhZ2dyZWdhdG9yQ29uZmlnLmFscGhhVmFudGFnZSA9IHtcbiAgICAgICAgYXBpS2V5OiBBTFBIQV9WQU5UQUdFX0FQSV9LRVksXG4gICAgICAgIHRpbWVvdXQ6IDE1MDAwLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoRk1QX0FQSV9LRVkpIHtcbiAgICAgIGFnZ3JlZ2F0b3JDb25maWcuZmluYW5jaWFsTW9kZWxpbmdQcmVwID0ge1xuICAgICAgICBhcGlLZXk6IEZNUF9BUElfS0VZLFxuICAgICAgICB0aW1lb3V0OiAxNTAwMCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgYWdncmVnYXRvckNvbmZpZy55YWhvb0ZpbmFuY2UgPSB7XG4gICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICB9O1xuXG4gICAgY29uc3QgZGF0YUFnZ3JlZ2F0b3IgPSBuZXcgRGF0YUFnZ3JlZ2F0b3IoYWdncmVnYXRvckNvbmZpZyk7XG4gICAgY29uc3QgZGF0YVByb2Nlc3NvciA9IG5ldyBEYXRhUHJvY2Vzc29yKFRBQkxFX05BTUUsIGRhdGFBZ2dyZWdhdG9yKTtcblxuICAgIC8vIEdldCBsaXN0IG9mIGNvbXBhbmllcyB0byB1cGRhdGVcbiAgICBjb25zdCBjb21wYW5pZXMgPSBhd2FpdCBnZXRDb21wYW5pZXNUb1VwZGF0ZSgpO1xuICAgIGNvbnNvbGUubG9nKGBGb3VuZCAke2NvbXBhbmllcy5sZW5ndGh9IGNvbXBhbmllcyB0byB1cGRhdGVgKTtcblxuICAgIC8vIFByb2Nlc3MgY29tcGFuaWVzIGluIGJhdGNoZXMgdG8gYXZvaWQgb3ZlcndoZWxtaW5nIEFQSXNcbiAgICBjb25zdCBiYXRjaFNpemUgPSA1OyAvLyBQcm9jZXNzIDUgY29tcGFuaWVzIGF0IGEgdGltZVxuICAgIGNvbnN0IGJhdGNoZXMgPSBbXTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbXBhbmllcy5sZW5ndGg7IGkgKz0gYmF0Y2hTaXplKSB7XG4gICAgICBiYXRjaGVzLnB1c2goY29tcGFuaWVzLnNsaWNlKGksIGkgKyBiYXRjaFNpemUpKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGJhdGNoIG9mIGJhdGNoZXMpIHtcbiAgICAgIGNvbnN0IGJhdGNoUHJvbWlzZXMgPSBiYXRjaC5tYXAoYXN5bmMgKGNvbXBhbnkpID0+IHtcbiAgICAgICAgY29uc3Qgam9iU3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgJHtjb21wYW55LnRpY2tlcn0uLi5gKTtcbiAgICAgICAgICBcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYXRhUHJvY2Vzc29yLnByb2Nlc3NDb21wYW55RGF0YShjb21wYW55LnRpY2tlciwge1xuICAgICAgICAgICAgbmFtZTogY29tcGFueS5uYW1lLFxuICAgICAgICAgICAgc2VjdG9yOiBjb21wYW55LnNlY3RvcixcbiAgICAgICAgICAgIG1hcmtldENhcDogY29tcGFueS5tYXJrZXRDYXAsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBjb25zdCBwcm9jZXNzaW5nVGltZSA9IERhdGUubm93KCkgLSBqb2JTdGFydFRpbWU7XG5cbiAgICAgICAgICBjb25zdCBqb2JSZXN1bHQ6IFN5bmNKb2JSZXN1bHQgPSB7XG4gICAgICAgICAgICBzeW1ib2w6IGNvbXBhbnkudGlja2VyLFxuICAgICAgICAgICAgc3VjY2VzczogcmVzdWx0LnN0b3JhZ2VSZXN1bHQuc3VjY2VzcyxcbiAgICAgICAgICAgIHJlY29yZHNVcGRhdGVkOiByZXN1bHQuc3RvcmFnZVJlc3VsdC5yZWNvcmRzU3RvcmVkLFxuICAgICAgICAgICAgZXJyb3JzOiBbXG4gICAgICAgICAgICAgIC4uLnJlc3VsdC5zdG9yYWdlUmVzdWx0LmVycm9ycyxcbiAgICAgICAgICAgICAgLi4ucmVzdWx0LnZhbGlkYXRpb25SZXN1bHRzLmZsYXRNYXAodiA9PiB2LmVycm9ycyksXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcXVhbGl0eVNjb3JlOiByZXN1bHQucXVhbGl0eU1ldHJpY3Mub3ZlcmFsbCxcbiAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lLFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICAvLyBVcGRhdGUgY29tcGFueSdzIGxhc3Qgc3luYyB0aW1lc3RhbXBcbiAgICAgICAgICBhd2FpdCB1cGRhdGVMYXN0U3luY1RpbWUoY29tcGFueS50aWNrZXIpO1xuXG4gICAgICAgICAgcmV0dXJuIGpvYlJlc3VsdDtcblxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIHByb2Nlc3NpbmcgJHtjb21wYW55LnRpY2tlcn06YCwgZXJyb3IpO1xuICAgICAgICAgIFxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzeW1ib2w6IGNvbXBhbnkudGlja2VyLFxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICByZWNvcmRzVXBkYXRlZDogMCxcbiAgICAgICAgICAgIGVycm9yczogW2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InXSxcbiAgICAgICAgICAgIHF1YWxpdHlTY29yZTogMCxcbiAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gam9iU3RhcnRUaW1lLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICAvLyBXYWl0IGZvciBiYXRjaCB0byBjb21wbGV0ZVxuICAgICAgY29uc3QgYmF0Y2hSZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwoYmF0Y2hQcm9taXNlcyk7XG4gICAgICByZXN1bHRzLnB1c2goLi4uYmF0Y2hSZXN1bHRzKTtcblxuICAgICAgLy8gQWRkIGRlbGF5IGJldHdlZW4gYmF0Y2hlcyB0byByZXNwZWN0IEFQSSByYXRlIGxpbWl0c1xuICAgICAgaWYgKGJhdGNoZXMuaW5kZXhPZihiYXRjaCkgPCBiYXRjaGVzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTsgLy8gNSBzZWNvbmQgZGVsYXlcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSBzdW1tYXJ5XG4gICAgY29uc3Qgc3VtbWFyeTogU3luY1N1bW1hcnkgPSB7XG4gICAgICB0b3RhbENvbXBhbmllczogY29tcGFuaWVzLmxlbmd0aCxcbiAgICAgIHN1Y2Nlc3NmdWxVcGRhdGVzOiByZXN1bHRzLmZpbHRlcihyID0+IHIuc3VjY2VzcykubGVuZ3RoLFxuICAgICAgZmFpbGVkVXBkYXRlczogcmVzdWx0cy5maWx0ZXIociA9PiAhci5zdWNjZXNzKS5sZW5ndGgsXG4gICAgICB0b3RhbFJlY29yZHNVcGRhdGVkOiByZXN1bHRzLnJlZHVjZSgoc3VtLCByKSA9PiBzdW0gKyByLnJlY29yZHNVcGRhdGVkLCAwKSxcbiAgICAgIGF2ZXJhZ2VRdWFsaXR5U2NvcmU6IHJlc3VsdHMubGVuZ3RoID4gMCBcbiAgICAgICAgPyByZXN1bHRzLnJlZHVjZSgoc3VtLCByKSA9PiBzdW0gKyByLnF1YWxpdHlTY29yZSwgMCkgLyByZXN1bHRzLmxlbmd0aCBcbiAgICAgICAgOiAwLFxuICAgICAgdG90YWxQcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgIGVycm9yczogcmVzdWx0cy5mbGF0TWFwKHIgPT4gci5lcnJvcnMpLFxuICAgIH07XG5cbiAgICAvLyBMb2cgc3VtbWFyeVxuICAgIGNvbnNvbGUubG9nKCdEYXRhIHN5bmMgY29tcGxldGVkOicsIHN1bW1hcnkpO1xuXG4gICAgLy8gU3RvcmUgc3luYyBtZXRyaWNzIGZvciBtb25pdG9yaW5nXG4gICAgYXdhaXQgc3RvcmVTeW5jTWV0cmljcyhzdW1tYXJ5LCByZXN1bHRzKTtcblxuICAgIHJldHVybiBzdW1tYXJ5O1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRmF0YWwgZXJyb3IgZHVyaW5nIGRhdGEgc3luYzonLCBlcnJvcik7XG4gICAgXG4gICAgY29uc3QgZXJyb3JTdW1tYXJ5OiBTeW5jU3VtbWFyeSA9IHtcbiAgICAgIHRvdGFsQ29tcGFuaWVzOiAwLFxuICAgICAgc3VjY2Vzc2Z1bFVwZGF0ZXM6IDAsXG4gICAgICBmYWlsZWRVcGRhdGVzOiAwLFxuICAgICAgdG90YWxSZWNvcmRzVXBkYXRlZDogMCxcbiAgICAgIGF2ZXJhZ2VRdWFsaXR5U2NvcmU6IDAsXG4gICAgICB0b3RhbFByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgZXJyb3JzOiBbZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBmYXRhbCBlcnJvciddLFxuICAgIH07XG5cbiAgICBhd2FpdCBzdG9yZVN5bmNNZXRyaWNzKGVycm9yU3VtbWFyeSwgW10pO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRDb21wYW5pZXNUb1VwZGF0ZSgpOiBQcm9taXNlPEFycmF5PHsgdGlja2VyOiBzdHJpbmc7IG5hbWU6IHN0cmluZzsgc2VjdG9yOiBzdHJpbmc7IG1hcmtldENhcDogbnVtYmVyOyBsYXN0VXBkYXRlZD86IHN0cmluZyB9Pj4ge1xuICB0cnkge1xuICAgIC8vIEdldCBhbGwgY29tcGFuaWVzIGZyb20gRHluYW1vREJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICdTSyA9IDpzaycsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6c2snOiAnTUVUQURBVEEnLFxuICAgICAgfSxcbiAgICAgIFByb2plY3Rpb25FeHByZXNzaW9uOiAndGlja2VyLCAjbmFtZSwgc2VjdG9yLCBtYXJrZXRDYXAsIGxhc3RVcGRhdGVkJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI25hbWUnOiAnbmFtZScsIC8vICduYW1lJyBpcyBhIHJlc2VydmVkIHdvcmQgaW4gRHluYW1vREJcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBjb25zdCBjb21wYW5pZXMgPSAocmVzdWx0Lkl0ZW1zIHx8IFtdKS5tYXAoaXRlbSA9PiAoe1xuICAgICAgdGlja2VyOiBpdGVtLnRpY2tlcixcbiAgICAgIG5hbWU6IGl0ZW0ubmFtZSB8fCBpdGVtLnRpY2tlcixcbiAgICAgIHNlY3RvcjogaXRlbS5zZWN0b3IgfHwgJ1Vua25vd24nLFxuICAgICAgbWFya2V0Q2FwOiBpdGVtLm1hcmtldENhcCB8fCAwLFxuICAgICAgbGFzdFVwZGF0ZWQ6IGl0ZW0ubGFzdFVwZGF0ZWQsXG4gICAgfSkpO1xuXG4gICAgLy8gSWYgbm8gY29tcGFuaWVzIGV4aXN0LCByZXR1cm4gYSBkZWZhdWx0IGxpc3Qgb2YgcG9wdWxhciBjb21wYW5pZXNcbiAgICBpZiAoY29tcGFuaWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIGdldERlZmF1bHRDb21wYW5pZXMoKTtcbiAgICB9XG5cbiAgICAvLyBTb3J0IGJ5IGxhc3QgdXBkYXRlZCAob2xkZXN0IGZpcnN0KSBhbmQgbWFya2V0IGNhcCAobGFyZ2VzdCBmaXJzdClcbiAgICByZXR1cm4gY29tcGFuaWVzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGNvbnN0IGFMYXN0VXBkYXRlZCA9IG5ldyBEYXRlKGEubGFzdFVwZGF0ZWQgfHwgJzE5NzAtMDEtMDEnKS5nZXRUaW1lKCk7XG4gICAgICBjb25zdCBiTGFzdFVwZGF0ZWQgPSBuZXcgRGF0ZShiLmxhc3RVcGRhdGVkIHx8ICcxOTcwLTAxLTAxJykuZ2V0VGltZSgpO1xuICAgICAgXG4gICAgICBpZiAoYUxhc3RVcGRhdGVkICE9PSBiTGFzdFVwZGF0ZWQpIHtcbiAgICAgICAgcmV0dXJuIGFMYXN0VXBkYXRlZCAtIGJMYXN0VXBkYXRlZDsgLy8gT2xkZXN0IGZpcnN0XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiBiLm1hcmtldENhcCAtIGEubWFya2V0Q2FwOyAvLyBMYXJnZXN0IG1hcmtldCBjYXAgZmlyc3RcbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGdldHRpbmcgY29tcGFuaWVzIHRvIHVwZGF0ZTonLCBlcnJvcik7XG4gICAgcmV0dXJuIGdldERlZmF1bHRDb21wYW5pZXMoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXREZWZhdWx0Q29tcGFuaWVzKCk6IEFycmF5PHsgdGlja2VyOiBzdHJpbmc7IG5hbWU6IHN0cmluZzsgc2VjdG9yOiBzdHJpbmc7IG1hcmtldENhcDogbnVtYmVyIH0+IHtcbiAgcmV0dXJuIFtcbiAgICB7IHRpY2tlcjogJ0FBUEwnLCBuYW1lOiAnQXBwbGUgSW5jLicsIHNlY3RvcjogJ1RlY2hub2xvZ3knLCBtYXJrZXRDYXA6IDMwMDAwMDAwMDAwMDAgfSxcbiAgICB7IHRpY2tlcjogJ01TRlQnLCBuYW1lOiAnTWljcm9zb2Z0IENvcnBvcmF0aW9uJywgc2VjdG9yOiAnVGVjaG5vbG9neScsIG1hcmtldENhcDogMjgwMDAwMDAwMDAwMCB9LFxuICAgIHsgdGlja2VyOiAnR09PR0wnLCBuYW1lOiAnQWxwaGFiZXQgSW5jLicsIHNlY3RvcjogJ1RlY2hub2xvZ3knLCBtYXJrZXRDYXA6IDE3MDAwMDAwMDAwMDAgfSxcbiAgICB7IHRpY2tlcjogJ0FNWk4nLCBuYW1lOiAnQW1hem9uLmNvbSBJbmMuJywgc2VjdG9yOiAnQ29uc3VtZXIgRGlzY3JldGlvbmFyeScsIG1hcmtldENhcDogMTUwMDAwMDAwMDAwMCB9LFxuICAgIHsgdGlja2VyOiAnVFNMQScsIG5hbWU6ICdUZXNsYSBJbmMuJywgc2VjdG9yOiAnQ29uc3VtZXIgRGlzY3JldGlvbmFyeScsIG1hcmtldENhcDogODAwMDAwMDAwMDAwIH0sXG4gICAgeyB0aWNrZXI6ICdNRVRBJywgbmFtZTogJ01ldGEgUGxhdGZvcm1zIEluYy4nLCBzZWN0b3I6ICdUZWNobm9sb2d5JywgbWFya2V0Q2FwOiA3NTAwMDAwMDAwMDAgfSxcbiAgICB7IHRpY2tlcjogJ05WREEnLCBuYW1lOiAnTlZJRElBIENvcnBvcmF0aW9uJywgc2VjdG9yOiAnVGVjaG5vbG9neScsIG1hcmtldENhcDogMTgwMDAwMDAwMDAwMCB9LFxuICAgIHsgdGlja2VyOiAnSlBNJywgbmFtZTogJ0pQTW9yZ2FuIENoYXNlICYgQ28uJywgc2VjdG9yOiAnRmluYW5jaWFsIFNlcnZpY2VzJywgbWFya2V0Q2FwOiA1MDAwMDAwMDAwMDAgfSxcbiAgICB7IHRpY2tlcjogJ0pOSicsIG5hbWU6ICdKb2huc29uICYgSm9obnNvbicsIHNlY3RvcjogJ0hlYWx0aGNhcmUnLCBtYXJrZXRDYXA6IDQ1MDAwMDAwMDAwMCB9LFxuICAgIHsgdGlja2VyOiAnVicsIG5hbWU6ICdWaXNhIEluYy4nLCBzZWN0b3I6ICdGaW5hbmNpYWwgU2VydmljZXMnLCBtYXJrZXRDYXA6IDUwMDAwMDAwMDAwMCB9LFxuICBdO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVMYXN0U3luY1RpbWUodGlja2VyOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgUHV0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICBJdGVtOiB7XG4gICAgICAgIFBLOiBgQ09NUEFOWSMke3RpY2tlci50b1VwcGVyQ2FzZSgpfWAsXG4gICAgICAgIFNLOiAnU1lOQ19NRVRBREFUQScsXG4gICAgICAgIGxhc3RTeW5jVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB0aWNrZXI6IHRpY2tlci50b1VwcGVyQ2FzZSgpLFxuICAgICAgfSxcbiAgICB9KSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gdXBkYXRlIHN5bmMgdGltZSBmb3IgJHt0aWNrZXJ9OmAsIGVycm9yKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzdG9yZVN5bmNNZXRyaWNzKHN1bW1hcnk6IFN5bmNTdW1tYXJ5LCByZXN1bHRzOiBTeW5jSm9iUmVzdWx0W10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgY29uc3QgZGF0ZSA9IHRpbWVzdGFtcC5zcGxpdCgnVCcpWzBdO1xuXG4gICAgLy8gU3RvcmUgZGFpbHkgc3VtbWFyeVxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBQdXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgIEl0ZW06IHtcbiAgICAgICAgUEs6ICdTWU5DX01FVFJJQ1MnLFxuICAgICAgICBTSzogYERBSUxZIyR7ZGF0ZX1gLFxuICAgICAgICB0aW1lc3RhbXAsXG4gICAgICAgIC4uLnN1bW1hcnksXG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIC8vIFN0b3JlIGluZGl2aWR1YWwgam9iIHJlc3VsdHMgZm9yIGRldGFpbGVkIGFuYWx5c2lzXG4gICAgY29uc3QgYmF0Y2hTaXplID0gMjU7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHRzLmxlbmd0aDsgaSArPSBiYXRjaFNpemUpIHtcbiAgICAgIGNvbnN0IGJhdGNoID0gcmVzdWx0cy5zbGljZShpLCBpICsgYmF0Y2hTaXplKTtcbiAgICAgIFxuICAgICAgY29uc3QgcHV0UmVxdWVzdHMgPSBiYXRjaC5tYXAoKHJlc3VsdCwgaW5kZXgpID0+ICh7XG4gICAgICAgIFB1dFJlcXVlc3Q6IHtcbiAgICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgICBQSzogJ1NZTkNfTUVUUklDUycsXG4gICAgICAgICAgICBTSzogYEpPQiMke2RhdGV9IyR7U3RyaW5nKGkgKyBpbmRleCkucGFkU3RhcnQoNCwgJzAnKX1gLFxuICAgICAgICAgICAgdGltZXN0YW1wLFxuICAgICAgICAgICAgLi4ucmVzdWx0LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KSk7XG5cbiAgICAgIGlmIChwdXRSZXF1ZXN0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBCYXRjaFdyaXRlQ29tbWFuZCh7XG4gICAgICAgICAgUmVxdWVzdEl0ZW1zOiB7XG4gICAgICAgICAgICBbVEFCTEVfTkFNRV06IHB1dFJlcXVlc3RzLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzdG9yaW5nIHN5bmMgbWV0cmljczonLCBlcnJvcik7XG4gIH1cbn0iXX0=