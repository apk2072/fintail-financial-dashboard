#!/usr/bin/env ts-node
"use strict";
/**
 * Script to populate DynamoDB with real financial data
 * Uses Yahoo Finance API (no API key required)
 */
Object.defineProperty(exports, "__esModule", { value: true });
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const https_1 = require("https");
const TABLE_NAME = 'fintail-companies-development';
const client = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
// List of companies to populate
const COMPANIES = [
    { ticker: 'AAPL', name: 'Apple Inc.', sector: 'Technology' },
    { ticker: 'MSFT', name: 'Microsoft Corporation', sector: 'Technology' },
    { ticker: 'GOOGL', name: 'Alphabet Inc.', sector: 'Technology' },
    { ticker: 'AMZN', name: 'Amazon.com Inc.', sector: 'Consumer Discretionary' },
    { ticker: 'TSLA', name: 'Tesla Inc.', sector: 'Consumer Discretionary' },
    { ticker: 'META', name: 'Meta Platforms Inc.', sector: 'Technology' },
    { ticker: 'NVDA', name: 'NVIDIA Corporation', sector: 'Technology' },
    { ticker: 'JPM', name: 'JPMorgan Chase & Co.', sector: 'Financial Services' },
];
async function fetchYahooFinanceData(ticker) {
    return new Promise((resolve) => {
        const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${ticker}?modules=incomeStatementHistoryQuarterly,cashflowStatementHistoryQuarterly,earnings`;
        https_1.default.get(url, (res) => {
            let data = '';
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                try {
                    const json = JSON.parse(data);
                    const result = json.quoteSummary?.result?.[0];
                    if (!result) {
                        console.log(`No data found for ${ticker}`);
                        resolve(null);
                        return;
                    }
                    const incomeStatements = result.incomeStatementHistoryQuarterly?.incomeStatementHistory || [];
                    const cashFlowStatements = result.cashflowStatementHistoryQuarterly?.cashflowStatements || [];
                    const quarterlyData = incomeStatements.slice(0, 8).map((statement, index) => {
                        const cashFlow = cashFlowStatements[index] || {};
                        const date = new Date(statement.endDate?.fmt || statement.endDate?.raw * 1000);
                        const quarter = `Q${Math.floor(date.getMonth() / 3) + 1} ${date.getFullYear()}`;
                        return {
                            quarter,
                            reportDate: date.toISOString().split('T')[0],
                            totalRevenue: statement.totalRevenue?.raw || 0,
                            netSales: statement.totalRevenue?.raw || 0,
                            netIncome: statement.netIncome?.raw || 0,
                            eps: statement.netIncome?.raw / (statement.shares?.raw || 1),
                            operatingIncome: statement.operatingIncome?.raw || 0,
                            freeCashFlow: cashFlow.freeCashFlow?.raw || 0,
                            totalAssets: statement.totalAssets?.raw,
                            sharesOutstanding: statement.shares?.raw,
                        };
                    });
                    resolve({
                        symbol: ticker,
                        quarterlyFinancials: quarterlyData,
                    });
                }
                catch (error) {
                    console.error(`Error parsing data for ${ticker}:`, error);
                    resolve(null);
                }
            });
        }).on('error', (error) => {
            console.error(`Error fetching data for ${ticker}:`, error);
            resolve(null);
        });
    });
}
async function storeCompanyData(company, financialData) {
    try {
        // Store company metadata
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: TABLE_NAME,
            Item: {
                PK: `COMPANY#${company.ticker}`,
                SK: 'METADATA',
                ticker: company.ticker,
                name: company.name,
                sector: company.sector,
                lastUpdated: new Date().toISOString(),
                GSI1PK: `SECTOR#${company.sector}`,
                GSI1SK: company.name,
                SearchPK: 'COMPANY',
                SearchSK: `${company.name.toLowerCase()}#${company.ticker.toLowerCase()}`,
            },
        }));
        console.log(`✓ Stored metadata for ${company.ticker}`);
        // Store quarterly financial data
        if (financialData && financialData.quarterlyFinancials) {
            for (const quarter of financialData.quarterlyFinancials) {
                await docClient.send(new lib_dynamodb_1.PutCommand({
                    TableName: TABLE_NAME,
                    Item: {
                        PK: `COMPANY#${company.ticker}`,
                        SK: `QUARTER#${quarter.reportDate}`,
                        ticker: company.ticker,
                        ...quarter,
                    },
                }));
            }
            console.log(`✓ Stored ${financialData.quarterlyFinancials.length} quarters for ${company.ticker}`);
        }
    }
    catch (error) {
        console.error(`✗ Error storing data for ${company.ticker}:`, error);
    }
}
async function main() {
    console.log('Starting data population...\n');
    for (const company of COMPANIES) {
        console.log(`Fetching data for ${company.ticker} (${company.name})...`);
        const financialData = await fetchYahooFinanceData(company.ticker);
        await storeCompanyData(company, financialData);
        // Add delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 2000));
        console.log('');
    }
    console.log('Data population completed!');
}
main().catch(console.error);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdWxhdGUtZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBvcHVsYXRlLWRhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQTs7O0dBR0c7O0FBRUgsOERBQTBEO0FBQzFELHdEQUEyRTtBQUMzRSxpQ0FBMEI7QUFFMUIsTUFBTSxVQUFVLEdBQUcsK0JBQStCLENBQUM7QUFFbkQsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUV0RCxnQ0FBZ0M7QUFDaEMsTUFBTSxTQUFTLEdBQUc7SUFDaEIsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRTtJQUM1RCxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLHVCQUF1QixFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUU7SUFDdkUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRTtJQUNoRSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sRUFBRSx3QkFBd0IsRUFBRTtJQUM3RSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsd0JBQXdCLEVBQUU7SUFDeEUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxxQkFBcUIsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFO0lBQ3JFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRTtJQUNwRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLHNCQUFzQixFQUFF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Q0FBQyxxQkFBcUIsT0FBTyxDQUFDLE1BQU0sS0FBSyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQztRQUV4RSxNQUFNLGFBQWEsR0FBRyxNQUFNLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsRSxNQUFNLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUUvQyxtQ0FBbUM7UUFDbkMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUV4RCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLDRCQUE0QixDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUVELElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiB0cy1ub2RlXG5cbi8qKlxuICogU2NyaXB0IHRvIHBvcHVsYXRlIER5bmFtb0RCIHdpdGggcmVhbCBmaW5hbmNpYWwgZGF0YVxuICogVXNlcyBZYWhvbyBGaW5hbmNlIEFQSSAobm8gQVBJIGtleSByZXF1aXJlZClcbiAqL1xuXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBQdXRDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCBodHRwcyBmcm9tICdodHRwcyc7XG5cbmNvbnN0IFRBQkxFX05BTUUgPSAnZmludGFpbC1jb21wYW5pZXMtZGV2ZWxvcG1lbnQnO1xuXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGNsaWVudCk7XG5cbi8vIExpc3Qgb2YgY29tcGFuaWVzIHRvIHBvcHVsYXRlXG5jb25zdCBDT01QQU5JRVMgPSBbXG4gIHsgdGlja2VyOiAnQUFQTCcsIG5hbWU6ICdBcHBsZSBJbmMuJywgc2VjdG9yOiAnVGVjaG5vbG9neScgfSxcbiAgeyB0aWNrZXI6ICdNU0ZUJywgbmFtZTogJ01pY3Jvc29mdCBDb3Jwb3JhdGlvbicsIHNlY3RvcjogJ1RlY2hub2xvZ3knIH0sXG4gIHsgdGlja2VyOiAnR09PR0wnLCBuYW1lOiAnQWxwaGFiZXQgSW5jLicsIHNlY3RvcjogJ1RlY2hub2xvZ3knIH0sXG4gIHsgdGlja2VyOiAnQU1aTicsIG5hbWU6ICdBbWF6b24uY29tIEluYy4nLCBzZWN0b3I6ICdDb25zdW1lciBEaXNjcmV0aW9uYXJ5JyB9LFxuICB7IHRpY2tlcjogJ1RTTEEnLCBuYW1lOiAnVGVzbGEgSW5jLicsIHNlY3RvcjogJ0NvbnN1bWVyIERpc2NyZXRpb25hcnknIH0sXG4gIHsgdGlja2VyOiAnTUVUQScsIG5hbWU6ICdNZXRhIFBsYXRmb3JtcyBJbmMuJywgc2VjdG9yOiAnVGVjaG5vbG9neScgfSxcbiAgeyB0aWNrZXI6ICdOVkRBJywgbmFtZTogJ05WSURJQSBDb3Jwb3JhdGlvbicsIHNlY3RvcjogJ1RlY2hub2xvZ3knIH0sXG4gIHsgdGlja2VyOiAnSlBNJywgbmFtZTogJ0pQTW9yZ2FuIENoYXNlICYgQ28uJywgc2VjdG9yOiAnRmluYW5jaWFsIFNlcnZpY2VzJyB9LFxuXTtcblxuaW50ZXJmYWNlIFlhaG9vRmluYW5jZURhdGEge1xuICBzeW1ib2w6IHN0cmluZztcbiAgcXVhcnRlcmx5RmluYW5jaWFsczogQXJyYXk8e1xuICAgIGRhdGU6IHN0cmluZztcbiAgICByZXZlbnVlOiBudW1iZXI7XG4gICAgbmV0SW5jb21lOiBudW1iZXI7XG4gICAgZXBzOiBudW1iZXI7XG4gICAgb3BlcmF0aW5nSW5jb21lOiBudW1iZXI7XG4gICAgZnJlZUNhc2hGbG93OiBudW1iZXI7XG4gIH0+O1xufVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaFlhaG9vRmluYW5jZURhdGEodGlja2VyOiBzdHJpbmcpOiBQcm9taXNlPFlhaG9vRmluYW5jZURhdGEgfCBudWxsPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGNvbnN0IHVybCA9IGBodHRwczovL3F1ZXJ5Mi5maW5hbmNlLnlhaG9vLmNvbS92MTAvZmluYW5jZS9xdW90ZVN1bW1hcnkvJHt0aWNrZXJ9P21vZHVsZXM9aW5jb21lU3RhdGVtZW50SGlzdG9yeVF1YXJ0ZXJseSxjYXNoZmxvd1N0YXRlbWVudEhpc3RvcnlRdWFydGVybHksZWFybmluZ3NgO1xuICAgIFxuICAgIGh0dHBzLmdldCh1cmwsIChyZXMpID0+IHtcbiAgICAgIGxldCBkYXRhID0gJyc7XG4gICAgICBcbiAgICAgIHJlcy5vbignZGF0YScsIChjaHVuaykgPT4ge1xuICAgICAgICBkYXRhICs9IGNodW5rO1xuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHJlcy5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGpzb24ucXVvdGVTdW1tYXJ5Py5yZXN1bHQ/LlswXTtcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYE5vIGRhdGEgZm91bmQgZm9yICR7dGlja2VyfWApO1xuICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgY29uc3QgaW5jb21lU3RhdGVtZW50cyA9IHJlc3VsdC5pbmNvbWVTdGF0ZW1lbnRIaXN0b3J5UXVhcnRlcmx5Py5pbmNvbWVTdGF0ZW1lbnRIaXN0b3J5IHx8IFtdO1xuICAgICAgICAgIGNvbnN0IGNhc2hGbG93U3RhdGVtZW50cyA9IHJlc3VsdC5jYXNoZmxvd1N0YXRlbWVudEhpc3RvcnlRdWFydGVybHk/LmNhc2hmbG93U3RhdGVtZW50cyB8fCBbXTtcbiAgICAgICAgICBcbiAgICAgICAgICBjb25zdCBxdWFydGVybHlEYXRhID0gaW5jb21lU3RhdGVtZW50cy5zbGljZSgwLCA4KS5tYXAoKHN0YXRlbWVudDogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjYXNoRmxvdyA9IGNhc2hGbG93U3RhdGVtZW50c1tpbmRleF0gfHwge307XG4gICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoc3RhdGVtZW50LmVuZERhdGU/LmZtdCB8fCBzdGF0ZW1lbnQuZW5kRGF0ZT8ucmF3ICogMTAwMCk7XG4gICAgICAgICAgICBjb25zdCBxdWFydGVyID0gYFEke01hdGguZmxvb3IoZGF0ZS5nZXRNb250aCgpIC8gMykgKyAxfSAke2RhdGUuZ2V0RnVsbFllYXIoKX1gO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBxdWFydGVyLFxuICAgICAgICAgICAgICByZXBvcnREYXRlOiBkYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgICAgICAgICAgdG90YWxSZXZlbnVlOiBzdGF0ZW1lbnQudG90YWxSZXZlbnVlPy5yYXcgfHwgMCxcbiAgICAgICAgICAgICAgbmV0U2FsZXM6IHN0YXRlbWVudC50b3RhbFJldmVudWU/LnJhdyB8fCAwLFxuICAgICAgICAgICAgICBuZXRJbmNvbWU6IHN0YXRlbWVudC5uZXRJbmNvbWU/LnJhdyB8fCAwLFxuICAgICAgICAgICAgICBlcHM6IHN0YXRlbWVudC5uZXRJbmNvbWU/LnJhdyAvIChzdGF0ZW1lbnQuc2hhcmVzPy5yYXcgfHwgMSksXG4gICAgICAgICAgICAgIG9wZXJhdGluZ0luY29tZTogc3RhdGVtZW50Lm9wZXJhdGluZ0luY29tZT8ucmF3IHx8IDAsXG4gICAgICAgICAgICAgIGZyZWVDYXNoRmxvdzogY2FzaEZsb3cuZnJlZUNhc2hGbG93Py5yYXcgfHwgMCxcbiAgICAgICAgICAgICAgdG90YWxBc3NldHM6IHN0YXRlbWVudC50b3RhbEFzc2V0cz8ucmF3LFxuICAgICAgICAgICAgICBzaGFyZXNPdXRzdGFuZGluZzogc3RhdGVtZW50LnNoYXJlcz8ucmF3LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBcbiAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgIHN5bWJvbDogdGlja2VyLFxuICAgICAgICAgICAgcXVhcnRlcmx5RmluYW5jaWFsczogcXVhcnRlcmx5RGF0YSBhcyBhbnksXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgcGFyc2luZyBkYXRhIGZvciAke3RpY2tlcn06YCwgZXJyb3IpO1xuICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgZmV0Y2hpbmcgZGF0YSBmb3IgJHt0aWNrZXJ9OmAsIGVycm9yKTtcbiAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdG9yZUNvbXBhbnlEYXRhKGNvbXBhbnk6IHR5cGVvZiBDT01QQU5JRVNbMF0sIGZpbmFuY2lhbERhdGE6IFlhaG9vRmluYW5jZURhdGEgfCBudWxsKSB7XG4gIHRyeSB7XG4gICAgLy8gU3RvcmUgY29tcGFueSBtZXRhZGF0YVxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBQdXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgIEl0ZW06IHtcbiAgICAgICAgUEs6IGBDT01QQU5ZIyR7Y29tcGFueS50aWNrZXJ9YCxcbiAgICAgICAgU0s6ICdNRVRBREFUQScsXG4gICAgICAgIHRpY2tlcjogY29tcGFueS50aWNrZXIsXG4gICAgICAgIG5hbWU6IGNvbXBhbnkubmFtZSxcbiAgICAgICAgc2VjdG9yOiBjb21wYW55LnNlY3RvcixcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgR1NJMVBLOiBgU0VDVE9SIyR7Y29tcGFueS5zZWN0b3J9YCxcbiAgICAgICAgR1NJMVNLOiBjb21wYW55Lm5hbWUsXG4gICAgICAgIFNlYXJjaFBLOiAnQ09NUEFOWScsXG4gICAgICAgIFNlYXJjaFNLOiBgJHtjb21wYW55Lm5hbWUudG9Mb3dlckNhc2UoKX0jJHtjb21wYW55LnRpY2tlci50b0xvd2VyQ2FzZSgpfWAsXG4gICAgICB9LFxuICAgIH0pKTtcbiAgICBcbiAgICBjb25zb2xlLmxvZyhg4pyTIFN0b3JlZCBtZXRhZGF0YSBmb3IgJHtjb21wYW55LnRpY2tlcn1gKTtcbiAgICBcbiAgICAvLyBTdG9yZSBxdWFydGVybHkgZmluYW5jaWFsIGRhdGFcbiAgICBpZiAoZmluYW5jaWFsRGF0YSAmJiBmaW5hbmNpYWxEYXRhLnF1YXJ0ZXJseUZpbmFuY2lhbHMpIHtcbiAgICAgIGZvciAoY29uc3QgcXVhcnRlciBvZiBmaW5hbmNpYWxEYXRhLnF1YXJ0ZXJseUZpbmFuY2lhbHMpIHtcbiAgICAgICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFB1dENvbW1hbmQoe1xuICAgICAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgICBQSzogYENPTVBBTlkjJHtjb21wYW55LnRpY2tlcn1gLFxuICAgICAgICAgICAgU0s6IGBRVUFSVEVSIyR7cXVhcnRlci5yZXBvcnREYXRlfWAsXG4gICAgICAgICAgICB0aWNrZXI6IGNvbXBhbnkudGlja2VyLFxuICAgICAgICAgICAgLi4ucXVhcnRlcixcbiAgICAgICAgICB9LFxuICAgICAgICB9KSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKGDinJMgU3RvcmVkICR7ZmluYW5jaWFsRGF0YS5xdWFydGVybHlGaW5hbmNpYWxzLmxlbmd0aH0gcXVhcnRlcnMgZm9yICR7Y29tcGFueS50aWNrZXJ9YCk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoYOKclyBFcnJvciBzdG9yaW5nIGRhdGEgZm9yICR7Y29tcGFueS50aWNrZXJ9OmAsIGVycm9yKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBtYWluKCkge1xuICBjb25zb2xlLmxvZygnU3RhcnRpbmcgZGF0YSBwb3B1bGF0aW9uLi4uXFxuJyk7XG4gIFxuICBmb3IgKGNvbnN0IGNvbXBhbnkgb2YgQ09NUEFOSUVTKSB7XG4gICAgY29uc29sZS5sb2coYEZldGNoaW5nIGRhdGEgZm9yICR7Y29tcGFueS50aWNrZXJ9ICgke2NvbXBhbnkubmFtZX0pLi4uYCk7XG4gICAgXG4gICAgY29uc3QgZmluYW5jaWFsRGF0YSA9IGF3YWl0IGZldGNoWWFob29GaW5hbmNlRGF0YShjb21wYW55LnRpY2tlcik7XG4gICAgYXdhaXQgc3RvcmVDb21wYW55RGF0YShjb21wYW55LCBmaW5hbmNpYWxEYXRhKTtcbiAgICBcbiAgICAvLyBBZGQgZGVsYXkgdG8gYXZvaWQgcmF0ZSBsaW1pdGluZ1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDAwKSk7XG4gICAgXG4gICAgY29uc29sZS5sb2coJycpO1xuICB9XG4gIFxuICBjb25zb2xlLmxvZygnRGF0YSBwb3B1bGF0aW9uIGNvbXBsZXRlZCEnKTtcbn1cblxubWFpbigpLmNhdGNoKGNvbnNvbGUuZXJyb3IpO1xuIl19